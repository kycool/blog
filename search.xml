<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>资源加速系列之 Github</title>
    <url>/posts/19128/</url>
    <content><![CDATA[<h3 id="1-故事发生背景"><a href="#1-故事发生背景" class="headerlink" title="1 故事发生背景"></a>1 故事发生背景</h3><p>这段时间，github 的 clone 快搞死人了，速度慢的一逼，上网看了几种方法<span id="more"></span></p>
<ol>
<li>改 hosts （亲测差异不大）</li>
<li>先拉到 gitee，再从 gitee 克隆</li>
<li>走代理</li>
</ol>
<p>我使用了代理，第二种方法不适合我，为什么，一个是自己懒，另外一个就是安装某些软件，这些软件特么的自己写死了 clone 地址（一般都是不能改的），所以果断抛弃，直奔第三种方式</p>
<!--more-->

<h3 id="2-执行方法"><a href="#2-执行方法" class="headerlink" title="2 执行方法"></a>2 执行方法</h3><p><strong>走代理，你特么的需要个梯子呀</strong></p>
<p>我使用的是 ss 服务，看图说话</p>
<p><img src="/images/addGithubSpeed_ssproxy.png" alt="ssproxy.png"></p>
<p>很清晰，没毛病，然后进行下一步</p>
<p>不同的协议他的代理配置各不相同</p>
<ul>
<li><code>core.gitproxy</code>  用于  <code>git://</code>  协议</li>
<li><code>http.proxy</code>  用于  <code>http://</code>  协议</li>
<li><code>https.proxy</code>  用于  <code>https://</code>  协议</li>
</ul>
<p>全局设置 git 的配置</p>
<figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"># 这里是针对 http 和 https 协议的</span><br><span class="line">git <span class="keyword">config</span> --<span class="keyword">global</span> http<span class="variable">.proxy</span> &#x27;socks5:<span class="comment">//127.0.0.1:1086&#x27;</span></span><br><span class="line">git <span class="keyword">config</span> --<span class="keyword">global</span> https<span class="variable">.proxy</span> &#x27;socks5:<span class="comment">//127.0.0.1:1086&#x27;</span></span><br><span class="line"></span><br><span class="line"># 这里是针对 git 协议的</span><br><span class="line">git <span class="keyword">config</span> --<span class="keyword">global</span> core<span class="variable">.gitproxy</span> <span class="string">&quot;git-proxy&quot;</span></span><br><span class="line">git <span class="keyword">config</span> --<span class="keyword">global</span> socks<span class="variable">.proxy</span> &#x27;socks5:<span class="comment">//127.0.0.1:1086&#x27;</span></span><br></pre></td></tr></table></figure>

<p>设置完后, 看下 git 的全局配置 <code>git config --global --list</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user.name=xxxx</span><br><span class="line">user.email=xxxxx@gmail.com</span><br><span class="line">core.excludesfile=/Users/kycool/.gitignore_global</span><br><span class="line">core.gitproxy=git-proxy</span><br><span class="line">difftool.sourcetree.cmd=opendiff <span class="string">&quot;$LOCAL&quot;</span> <span class="string">&quot;$REMOTE&quot;</span></span><br><span class="line">difftool.sourcetree.path=</span><br><span class="line">mergetool.sourcetree.cmd=/Applications/Sourcetree.app/Contents/Resources/opendiff-w.sh <span class="string">&quot;$LOCAL&quot;</span> <span class="string">&quot;$REMOTE&quot;</span> -ancestor <span class="string">&quot;$BASE&quot;</span> -merge <span class="string">&quot;$MERGED&quot;</span></span><br><span class="line">mergetool.sourcetree.trustexitcode=true</span><br><span class="line">commit.template=/Users/kycool/.stCommitMsg</span><br><span class="line">http.proxy=socks5://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1086</span></span><br><span class="line">https.proxy=socks5://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1086</span></span><br><span class="line">socks.proxy=socks5://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1086</span></span><br></pre></td></tr></table></figure>

<p>如果后面想删掉这些配置，则可以执行以下命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">git config --<span class="keyword">global</span> --unset 键</span><br></pre></td></tr></table></figure>

<p>添加 ssh 配置，在 <code>.ssh/config</code> 文件中添加</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">HostName github.com</span><br><span class="line">User git</span><br><span class="line">port <span class="number">22</span></span><br><span class="line">UseKeychain yes</span><br><span class="line">IdentityFile /Users/kycool/.ssh/id_rsa</span><br><span class="line">ProxyCommand nc -v -x <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1086</span> %h %p</span><br></pre></td></tr></table></figure>

<p>好了，到享受的时候了，我测试了 git 协议和 https 协议</p>
<h3 id="3-克隆测试"><a href="#3-克隆测试" class="headerlink" title="3 克隆测试"></a>3 克隆测试</h3><p><strong>git 协议</strong>: clone antd-pro</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$ git clone git@github.com:ant-design/ant-design-pro.git</span><br><span class="line">Cloning into <span class="string">&#x27;ant-design-pro&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">31</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">31</span>/<span class="number">31</span>), done.</span><br><span class="line">remote: Compressing objects: <span class="number">100</span>% (<span class="number">29</span>/<span class="number">29</span>), done.</span><br><span class="line">remote: Total <span class="number">18085</span> (delta <span class="number">9</span>), reused <span class="number">14</span> (delta <span class="number">2</span>), pack-reused <span class="number">18054</span></span><br><span class="line">Receiving objects: <span class="number">100</span>% (<span class="number">18085</span>/<span class="number">18085</span>), <span class="number">6.02</span> MiB | <span class="number">299.00</span> KiB/s, done.</span><br><span class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">12239</span>/<span class="number">12239</span>), done.</span><br></pre></td></tr></table></figure>

<p>从来没有见过的速度，几乎是秒杀</p>
<p><strong>https 协议</strong>: hexo init mm</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$ hexo init mm</span><br><span class="line">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class="line">Cloning into <span class="string">&#x27;/Users/kycool/Documents/test/mm&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">30</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">30</span>/<span class="number">30</span>), done.</span><br><span class="line">remote: Compressing objects: <span class="number">100</span>% (<span class="number">24</span>/<span class="number">24</span>), done.</span><br><span class="line">remote: Total <span class="number">161</span> (delta <span class="number">12</span>), reused <span class="number">12</span> (delta <span class="number">4</span>), pack-reused <span class="number">131</span></span><br><span class="line">Receiving objects: <span class="number">100</span>% (<span class="number">161</span>/<span class="number">161</span>), <span class="number">31.79</span> KiB | <span class="number">206.00</span> KiB/s, done.</span><br><span class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">74</span>/<span class="number">74</span>), done.</span><br><span class="line">Submodule <span class="string">&#x27;themes/landscape&#x27;</span> (https://github.com/hexojs/hexo-theme-landscape.git) registered <span class="keyword">for</span> path <span class="string">&#x27;themes/landscape&#x27;</span></span><br><span class="line">Cloning into <span class="string">&#x27;/Users/kycool/Documents/test/mm/themes/landscape&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: <span class="number">9</span>, done.</span><br><span class="line">remote: Counting objects: <span class="number">100</span>% (<span class="number">9</span>/<span class="number">9</span>), done.</span><br><span class="line">remote: Compressing objects: <span class="number">100</span>% (<span class="number">9</span>/<span class="number">9</span>), done.</span><br><span class="line">remote: Total <span class="number">1063</span> (delta <span class="number">1</span>), reused <span class="number">1</span> (delta <span class="number">0</span>), pack-reused <span class="number">1054</span></span><br><span class="line">Receiving objects: <span class="number">100</span>% (<span class="number">1063</span>/<span class="number">1063</span>), <span class="number">3.22</span> MiB | <span class="number">217.00</span> KiB/s, done.</span><br><span class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">582</span>/<span class="number">582</span>), done.</span><br><span class="line">Submodule path <span class="string">&#x27;themes/landscape&#x27;</span>: checked out <span class="string">&#x27;73a23c51f8487cfcd7c6deec96ccc7543960d350&#x27;</span></span><br><span class="line">INFO  Install dependencies</span><br></pre></td></tr></table></figure>

<p>速度和上面一个几乎不相上下。</p>
<p>测试的速度是不断变化的，我观察有瞬间跑到 600 KiB&#x2F;s，我估摸着如果代理服务器的带宽牛逼的话，那速度想都不敢想。</p>
<h3 id="4-不足的地方"><a href="#4-不足的地方" class="headerlink" title="4 不足的地方"></a>4 不足的地方</h3><p>这里面的哪一种方法都是有些不足的，梯子偶尔也会抽风，因为是我买的别人家的服务，这种保障不能主观控制，抽风就回到解放前了。</p>
]]></content>
      <categories>
        <category>资源加速</category>
      </categories>
      <tags>
        <tag>加速</tag>
      </tags>
  </entry>
  <entry>
    <title>本地开发使用 https</title>
    <url>/posts/32953/</url>
    <content><![CDATA[<p>这阵子本地开发测试，需要本地可以使用 HTTPS 证书，找到了 <code>mkcert</code> 这个傻瓜式的工具（<a href="https://github.com/FiloSottile/mkcert">https://github.com/FiloSottile/mkcert</a>),</p>
<p>mkcert 设计很简单，优雅，隐藏了几乎所有生成 TLS 证书所必须的知识，它适用于任何域名，主机名，IP，包括 localhost，但是切记，只能在本地使用。<span id="more"></span></p>
<p>证书是由你自己的私有 CA 签发，当你运行 <code>mkcert-install</code> 会自动配置这些信任，因此，当浏览器访问时，就会显示安全标识。</p>
<p>与 OpenSSL 不同的是，不需要为每个证书配置很多选项。mkcert 最主要的功能是作为开发者工具，聚焦于让本地环境配置 TLS 证书变得简单高效。</p>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1 安装"></a>1 安装</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brew install mkcert</span><br><span class="line">brew install nss # if you use Firefox</span><br></pre></td></tr></table></figure>

<h3 id="2-使用"><a href="#2-使用" class="headerlink" title="2 使用"></a>2 使用</h3><p>您需要首先在系统信任库中安装本地 CA.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mkcert -install</span></span><br><span class="line"></span><br><span class="line">Using the local CA at &quot;/Users/kycool/Library/Application Support/mkcert&quot; ✨</span><br><span class="line">The local CA is already installed in the system trust store! 👍</span><br></pre></td></tr></table></figure>

<p>完成后，可以给自己的本地域名生成证书了，生成证书很简单</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mkcert kycooltest.cn <span class="string">&#x27;*.kycooltest.cn&#x27;</span> localhost 127.0.0.1 ::1</span></span><br><span class="line">Using the local CA at &quot;/Users/kycool/Library/Application Support/mkcert&quot; ✨</span><br><span class="line"></span><br><span class="line">Created a new certificate valid for the following names 📜</span><br><span class="line"> - &quot;kycooltest.cn&quot;</span><br><span class="line"> - &quot;*.kycooltest.cn&quot;</span><br><span class="line"> - &quot;localhost&quot;</span><br><span class="line"> - &quot;127.0.0.1&quot;</span><br><span class="line"> - &quot;::1&quot;</span><br><span class="line"></span><br><span class="line">Reminder: X.509 wildcards only go one level deep, so this won&#x27;t match a.b.kycooltest.cn ℹ️</span><br><span class="line"></span><br><span class="line">The certificate is at &quot;./kycooltest.cn+4.pem&quot; and the key at &quot;./kycooltest.cn+4-key.pem&quot; ✅</span><br></pre></td></tr></table></figure>

<h3 id="3-验证"><a href="#3-验证" class="headerlink" title="3 验证"></a>3 验证</h3><p>添加本地 <code>hosts</code> 记录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> kycooltest.cn</span><br></pre></td></tr></table></figure>

<p>添加 nginx 配置文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen *:<span class="number">443</span> ssl;</span><br><span class="line">    server_name  kycooltest.cn;</span><br><span class="line"></span><br><span class="line">    root /var/www;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /Users/kycool/Documents/caddy/kycooltest.cn+<span class="number">4.</span>pem;</span><br><span class="line">    ssl_certificate_key /Users/kycool/Documents/caddy/kycooltest.cn+<span class="number">4</span>-key.pem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着在 浏览器中打开 <code>https://kycooltest.cn</code></p>
<p><img src="/images/mkcert.png" alt="mkcert.png"></p>
]]></content>
      <categories>
        <category>开发工具</category>
      </categories>
      <tags>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>Medium | 非订阅下阅读文章</title>
    <url>/posts/40149/</url>
    <content><![CDATA[<p>在不用订阅的情况下，不受限制的阅读文章，我一般都是使用 PC 进行阅读，因为宽屏看东西，比较爽。<span id="more"></span>列举下方法</p>
<h3 id="1-chrome-使用无痕模式"><a href="#1-chrome-使用无痕模式" class="headerlink" title="1 chrome 使用无痕模式"></a>1 chrome 使用无痕模式</h3><p>复制链接地址到无痕窗口打开，即可正常阅读。</p>
<p>缺点：每次阅读文章都需要走这样一篇流程，有些浪费功夫，对于我这样的 <code>medium</code> 重度用户，心态是要崩掉的。但是如果只是偶尔阅读下，可以这样操作。</p>
<h3 id="2-使用插件：medium-unlimited"><a href="#2-使用插件：medium-unlimited" class="headerlink" title="2 使用插件：medium-unlimited"></a>2 使用插件：medium-unlimited</h3><p>地址：<a href="https://github.com/manojVivek/medium-unlimited">https://github.com/manojVivek/medium-unlimited</a></p>
<p>安装后，即可顺滑流畅的享受阅读。</p>
<p>缺点：受浏览器限制，其实这个也不算是什么缺点，毕竟 <code>chrome</code> 和 <code>firefox</code> 算是很不错的浏览器了。</p>
]]></content>
      <categories>
        <category>杂记</category>
      </categories>
      <tags>
        <tag>Medium</tag>
      </tags>
  </entry>
  <entry>
    <title>Mac-解锁网易云置灰音乐</title>
    <url>/posts/41185/</url>
    <content><![CDATA[<p>我的网易云黑胶会员 VIP 到期了，暂时不想续期，找了个法子解锁置灰的歌，后面再想想续期的事情。解锁的原理比较简单，劫持网易云音乐客户端的请求，打到代理服务中去，代理服务会自动解析，如果有些歌听不了，会自动请求其他音源进行替换，这个大家都懂的。下面记录下步骤。<span id="more"></span></p>
<p>工具和对应的版本：</p>
<ul>
<li>网易云音乐 for mac：2.0.0 (690) 下载地址：<a href="http://d1.music.126.net/dmusic/NeteaseMusic_2.0.0_690_web.dmg">http://d1.music.126.net/dmusic/NeteaseMusic_2.0.0_690_web.dmg</a></li>
<li>mac: 10.15.5 (19F101)</li>
<li>node: v10.16.3</li>
<li>Proxifier for mac: v2.26 下载地址: <a href="https://xclient.info/s/proxifier.html">https://xclient.info/s/proxifier.html</a></li>
</ul>
<h3 id="1-下载解锁项目"><a href="#1-下载解锁项目" class="headerlink" title="1 下载解锁项目"></a>1 下载解锁项目</h3><p>Github：<a href="https://github.com/nondanee/UnblockNeteaseMusic">https://github.com/nondanee/UnblockNeteaseMusic</a></p>
<p>这里照着文档克隆，然后双击安装其中的 ca.crt 并设置信任。因为后面要跑服务，新建了 m.sh 并赋予可执行的权限，直接用 m.sh 代码如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">pattern=&#x27;[(].*[)]&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意这里改成自己的目录地址</span></span><br><span class="line">path=~/Documents/githubpro/UnblockNeteaseMusic/app.js</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里是获取 music.163.com 的 IP 地址</span></span><br><span class="line">ip=`ping music.163.com -c 1 | grep -o $pattern`</span><br><span class="line">ip=$&#123;ip:1&#125;</span><br><span class="line">ip=$&#123;ip%?&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里的端口号自己可以调整</span></span><br><span class="line">sudo node app.js -p 63455:7777 -f $ip</span><br></pre></td></tr></table></figure>

<p>然后在包含 m.sh 的目录下执行 m.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./m.sh</span></span><br><span class="line"></span><br><span class="line">HTTP Server running @ http://0.0.0.0:63455</span><br><span class="line">HTTPS Server running @ http://0.0.0.0:7777</span><br></pre></td></tr></table></figure>

<p>注意：ping music.163.com 出来的 IP 地址有可能是变化的，so 如果歌听不了，重新运行服务即可。</p>
<h3 id="2-代理设置"><a href="#2-代理设置" class="headerlink" title="2 代理设置"></a>2 代理设置</h3><p>因为网易云 mac 的客户端没有可以设置代理的地方，有些傲娇，那就使用 Proxifier 来解决吧。</p>
<p>2.1 添加 Proxies，地址写 127.0.0.1 端口对应上面，为 63455<br>2.2 添加 Rules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Applications 为 NeteaseMusic;com.apple.WebKit.Networking</span><br><span class="line"></span><br><span class="line">Target Hosts 为 *.music<span class="number">.163</span>.com;*.music<span class="number">.126</span>.net;*.netease.com;music<span class="number">.163</span>.com;interface.music<span class="number">.163</span>.com</span><br><span class="line"></span><br><span class="line">Action 为上面创建的，即 Proxy HTTPS <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">63455</span></span><br></pre></td></tr></table></figure>

<p>2.3 DNS 配置<br>在 Resolve hostnames through proxy 前面打勾</p>
<p>好了，代理配置好了。</p>
<h3 id="3-重启网易云音乐"><a href="#3-重启网易云音乐" class="headerlink" title="3 重启网易云音乐"></a>3 重启网易云音乐</h3><p>搜索 JAY 的歌，之前置灰的歌可以播放了，例如听以父之名，日志如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">TUNNEL &gt; localhost:63455</span><br><span class="line">MITM &gt; music.163.com</span><br><span class="line">MITM &gt; music.163.com</span><br><span class="line">[1400394244] 以父之名 (Live)</span><br><span class="line">http://sz.sycdn.kuwo.cn/cadd34fd7d42d643db5257b182f07ad5/5f57a6b9/resource/n1/69/17/1415834243.mp3</span><br><span class="line">MITM &gt; music.163.com</span><br></pre></td></tr></table></figure>

<p>使用这种方式听歌呢，因为要跑服务和代理，so 最好还是用脚本打开网易云音乐，省事。</p>
]]></content>
      <categories>
        <category>危险边缘</category>
      </categories>
      <tags>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Antd：Form 的 InitialValues 重置</title>
    <url>/posts/59046/</url>
    <content><![CDATA[<p>描述：编辑页面中 <code>Form</code> 的 <code>InitialValues</code> 的重置</p>
<span id="more"></span>

<h3 id="1-场景描述"><a href="#1-场景描述" class="headerlink" title="1 场景描述"></a>1 场景描述</h3><p>管理后台的通用场景，列表页面，然后点击新建或者更新，这里说的是更新的场景，异步请求，重新渲染表单。</p>
<p>管理后台使用 <code>antd-pro</code> 搭建，<code>antd</code> 使用了 <code>4.x</code> 版本，注意这个版本对 <code>Form</code> 做了些调整。</p>
<p>点击更新进入表单页面，我设置了 <code>state</code> 的初始值</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">state</span> = &#123;</span><br><span class="line">  initialValues: &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后异步请求，请求到结果后，需要重置 <code>initialValues</code>，但是根据 <code>antd</code> 的文档</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">initialValue</span> 表单默认值，只有初始化以及重置时生效</span><br></pre></td></tr></table></figure>

<p>所以异步请求后如果重新 <code>setState(&#123; initialValues &#125;)</code>，这样是无效的，你会看到对应的表单中没有数据，都是空的。只能重置，这种问题怎么解决掉</p>
<h3 id="2-重置-initialValues"><a href="#2-重置-initialValues" class="headerlink" title="2 重置 initialValues"></a>2 重置 initialValues</h3><p><strong>2.1 如果是函数式组件，官方推荐使用 <code>Form.useForm</code> 创建表单数据域进行控制</strong></p>
<p>使用用法如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [form] = <span class="title class_">Form</span>.<span class="title function_">useForm</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在异步请求中重置表单初始值</span></span><br><span class="line"><span class="title function_">asyncRequest</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">initialValues</span>) =&gt;</span> form.<span class="title function_">setFieldsValue</span>(&#123; initialValues &#125;));</span><br></pre></td></tr></table></figure>

<p><strong>2.2 如果是在 class component 下，你也可以通过 ref 获取数据域</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  formRef = <span class="title class_">React</span>.<span class="title function_">createRef</span>();</span><br><span class="line"></span><br><span class="line">  UNSAFE_componentWillMount = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在异步请求中重置表单初始值</span></span><br><span class="line">    <span class="title function_">asyncRequest</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">initialValues</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">formRef</span>.<span class="property">current</span>.<span class="title function_">setFieldsValue</span>(&#123; initialValues &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 <code>UNSAFE_componentWillMount</code> 声明周期函数，有些声明周期函数在未来版本中会被移除或者重命名，这个可以浏览 <a href="https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html">https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html</a></p>
<h3 id="3-完整的参考示例"><a href="#3-完整的参考示例" class="headerlink" title="3 完整的参考示例"></a>3 完整的参考示例</h3><p>这里我使用了类组件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Form</span>, <span class="title class_">Input</span>, <span class="title class_">Button</span> &#125; <span class="keyword">from</span> <span class="string">&quot;antd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">FairyUploader</span> <span class="keyword">from</span> <span class="string">&quot;@/fairy/components/Uploader&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">FairyRichTextEditor</span> <span class="keyword">from</span> <span class="string">&quot;@/fairy/components/RichTextEditor&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;@/utils/store&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">CreateUpdateForm</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">create</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">initialValues</span>: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  formRef = <span class="title class_">React</span>.<span class="title function_">createRef</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">UNSAFE_componentWillMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">match</span>.<span class="property">params</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据详情</span></span><br><span class="line">    <span class="keyword">if</span> (id) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">create</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      store</span><br><span class="line">        .<span class="title function_">dispatch</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&quot;product/retrieve&quot;</span>,</span><br><span class="line">          <span class="attr">payload</span>: &#123; id &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">initialValues</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">formRef</span>.<span class="property">current</span>.<span class="title function_">setFieldsValue</span>(initialValues);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onFinish = <span class="function">(<span class="params">values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Success:&quot;</span>, values);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  onFinishFailed = <span class="function">(<span class="params">errorInfo</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Failed:&quot;</span>, errorInfo);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; initialValues, create &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">const</span> formProps = &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;basic&quot;</span>,</span><br><span class="line">      <span class="attr">onFinish</span>: <span class="variable language_">this</span>.<span class="property">onFinish</span>,</span><br><span class="line">      <span class="attr">onFinishFailed</span>: <span class="variable language_">this</span>.<span class="property">onFinishFailed</span>,</span><br><span class="line">      initialValues,</span><br><span class="line">      <span class="attr">ref</span>: <span class="variable language_">this</span>.<span class="property">formRef</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Form</span> &#123;<span class="attr">...formProps</span>&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">label</span>=<span class="string">&quot;姓名&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">rules</span>=<span class="string">&#123;[&#123;</span> <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">message:</span> &quot;请填写姓名&quot; &#125;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">label</span>=<span class="string">&quot;职业&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;position&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">rules</span>=<span class="string">&#123;[&#123;</span> <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">message:</span> &quot;请输入职业&quot; &#125;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">label</span>=<span class="string">&quot;头像&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;avatar&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">rules</span>=<span class="string">&#123;[&#123;</span> <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">message:</span> &quot;请上传头像&quot; &#125;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">FairyUploader</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form.Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">label</span>=<span class="string">&quot;描述&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;description&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">rules</span>=<span class="string">&#123;[&#123;</span> <span class="attr">required:</span> <span class="attr">true</span>, <span class="attr">message:</span> &quot;请输入描述&quot; &#125;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">FairyRichTextEditor</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">htmlType</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;create ? &quot;保存&quot; : &quot;更新&quot;&#125;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-小结"><a href="#4-小结" class="headerlink" title="4 小结"></a>4 小结</h3><ul>
<li><code>antd</code> 对于各种使用场景还是给出了详细的说明和例子参考的，这个很赞。</li>
<li>使用 <code>React</code> 的各种警告，这个需要认真根据官方的引导进行调整。</li>
<li>根据上面的参考示例可以想到对于这种通用的更新创建表单，完全可以使用通用的 <code>HOC</code>，根据不同的配置渲染出不同的页面，这样一个高阶组件可以解决掉通用的创建更新表单。同样，对于列表页面也是如此，其实说白了，管理后台可以根据配置生成出来。对于一些需要自定义的业务，可以让高阶组件支持继承和钩子的重置来解决，如果实在解决不了的业务，可以单独写页面也是可以的。对于这个，我会专门写一篇文章来陈述下。</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>redux</tag>
        <tag>Antd</tag>
      </tags>
  </entry>
  <entry>
    <title>前端 | 重构 gulpfile.js</title>
    <url>/posts/18305/</url>
    <content><![CDATA[<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h3><p>前端任务打包工具选用的是 <code>gulp</code>, 当时选用 <code>gulp</code> 也是偶然，在使用 <code>grunt</code> 初期，翻阅 <code>dailyjs.com</code> 时发现一片文章着重介绍了 <code>gulp</code>, 甚至还预言是 <code>grunt</code> 的劲敌，好奇心驱使，确实发现，<code>gulp</code> 的流的概念更人性化，看着当时写的 <code>grunt</code> 配置文件，不忍直视<span id="more"></span></p>
<p>由于项目的不断迭代，前端的任务也在不断的迭代，任务越来越多，没有优化前，全部的任务都在一个单独的 <code>gulpfile.js</code> 中，后来随着时间的推移，发现修改一个任务时，查询好麻烦，五百行左右的代码让人烦躁，代码结构和 <a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/using-multiple-sources-in-one-task.md">https://github.com/gulpjs/gulp/blob/master/docs/recipes/using-multiple-sources-in-one-task.md</a> 如出一辙</p>
<p>重构 <code>gulpfile.js</code> 必须要进行</p>
<h3 id="2-重构迭代-1-拆分任务"><a href="#2-重构迭代-1-拆分任务" class="headerlink" title="2 重构迭代 1: 拆分任务"></a>2 重构迭代 1: 拆分任务</h3><p>最先是按照 <a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/split-tasks-across-multiple-files.md">https://github.com/gulpjs/gulp/blob/master/docs/recipes/split-tasks-across-multiple-files.md</a> 此文档中的架构进行迭代的</p>
<h4 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">gulpfile.<span class="property">js</span></span><br><span class="line">tasks/</span><br><span class="line">├── xxxx.<span class="property">js</span></span><br><span class="line">├── xxxx.<span class="property">js</span></span><br><span class="line">└── image.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<h4 id="image-js"><a href="#image-js" class="headerlink" title="image.js"></a>image.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> imagemin = <span class="built_in">require</span>(<span class="string">&quot;gulp-imagemin&quot;</span>);</span><br><span class="line"></span><br><span class="line">gulp.<span class="title function_">task</span>(<span class="string">&quot;img&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> gulp</span><br><span class="line">    .<span class="title function_">src</span>(<span class="string">&quot;./images/**/*.*&quot;</span>)</span><br><span class="line">    .<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">imagemin</span>(&#123;</span><br><span class="line">        <span class="attr">optimizationLevel</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">progressive</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./imagemini&quot;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="gulpfile-js"><a href="#gulpfile-js" class="headerlink" title="gulpfile.js"></a>gulpfile.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> requireDir = <span class="built_in">require</span>(<span class="string">&quot;require-dir&quot;</span>),</span><br><span class="line">  tasks = requireDir(<span class="string">&quot;./tasks&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这种文件架构让任务按照类型分成子任务放在单独的文件中，顿时感觉干净了很多，这时可以自由的添加子任务，而不用管 <code>gulpfile.js</code>, 此时子任务好比插件，需要就添加，没用就删除，相当方便</p>
<h3 id="3-重构迭代-2-避免模块和插件重复依赖"><a href="#3-重构迭代-2-避免模块和插件重复依赖" class="headerlink" title="3 重构迭代 2: 避免模块和插件重复依赖"></a>3 重构迭代 2: 避免模块和插件重复依赖</h3><p>随着时间的推移，发现这种组织架构还是有些不方便，不方便在哪里呢，每一个任务文件中，我都要写 <code>var xxx = require(&#39;xxx&#39;)</code>, 如果你是用上面的架构，任务多的时候，估计也会抓狂，因为你会发现 <code>插件和模块依赖被重复的引入进来</code>，这样就提高了成本</p>
<p>我不想在子任务文件中重复的引入 <code>插件或模块依赖</code>，有没有上面好方法，<code>stackoverflow</code> 是个好老师，老师告知：</p>
<ul>
<li>使用 <code>gulp-load-plugins</code> 插件<br>地址：<a href="https://www.npmjs.com/package/gulp-load-plugins">https://www.npmjs.com/package/gulp-load-plugins</a></li>
<li>把子任务封装成模块</li>
</ul>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">gulpfile.<span class="property">js</span></span><br><span class="line">tasks/</span><br><span class="line">├── xxxx.<span class="property">js</span></span><br><span class="line">├── xxxx.<span class="property">js</span></span><br><span class="line">└── image.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<h4 id="gulpfile-js-1"><a href="#gulpfile-js-1" class="headerlink" title="gulpfile.js"></a>gulpfile.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>),</span><br><span class="line">  gulpLoadPlugins = <span class="built_in">require</span>(<span class="string">&quot;gulp-load-plugins&quot;</span>);</span><br><span class="line"><span class="comment">// 这里请查看文档</span></span><br><span class="line">gulpLoadPlugins.<span class="property">imagemin</span> = <span class="built_in">require</span>(<span class="string">&quot;gulp-imagemin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;./tasks/image&quot;</span>)(gulp, gulpLoadPlugins);</span><br></pre></td></tr></table></figure>

<h4 id="image-js-1"><a href="#image-js-1" class="headerlink" title="image.js"></a>image.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">gulp, Plugin</span>) &#123;</span><br><span class="line">  gulp.<span class="title function_">task</span>(<span class="string">&quot;img&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">      .<span class="title function_">src</span>(<span class="string">&quot;./images/**/*.*&quot;</span>)</span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title class_">Plugin</span>.<span class="title function_">imagemin</span>(&#123;</span><br><span class="line">          <span class="attr">optimizationLevel</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">progressive</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">      .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./imagemini&quot;</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>运行任务 一切正常，此时一个文件测试已经 ok</p>
<p>但是 <code>./tasks</code> 下面是有很多的子任务，所以需要一个迭代加载，修改 <code>gulpfile.js</code> 如下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>),</span><br><span class="line">  gulpLoadPlugins = <span class="built_in">require</span>(<span class="string">&quot;gulp-load-plugins&quot;</span>),</span><br><span class="line">  <span class="comment">// 这里获取子任务文件列表 使用了 fs 模块</span></span><br><span class="line">  gulpTaskList = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>).<span class="title function_">readdirSync</span>(<span class="string">&quot;./tasks/&quot;</span>);</span><br><span class="line"><span class="comment">// 这里请查看文档</span></span><br><span class="line">gulpLoadPlugins.<span class="property">imagemin</span> = <span class="built_in">require</span>(<span class="string">&quot;gulp-imagemin&quot;</span>);</span><br><span class="line"></span><br><span class="line">gulpTaskList.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">taskfile</span>) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./tasks/&quot;</span> + taskfile)(gulp, gulpLoadPlugins);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这一次迭代避免了<code>重复依赖</code>的问题，但是你会发现，所有的依赖都声明在 <code>gulpTaskList</code> 命名空间下，如果你依赖很多插件或模块，<code>gulpfile.js</code> 也是相当长，鱼和熊掌不可兼得，在现在情况下，只能寻找最佳的解决方案</p>
<h3 id="4-重构迭代-3-参数配置全局化"><a href="#4-重构迭代-3-参数配置全局化" class="headerlink" title="4 重构迭代 3: 参数配置全局化"></a>4 重构迭代 3: 参数配置全局化</h3><p>其实第二部迭代之后，就可以满足大部分需求，但还是有小伙伴抱怨，有些子任务有相同的参数，能不能抽取出来，放到一个单独的文件中，so 继续翻阅文档</p>
<p>参考文档<a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/using-external-config-file.md">https://github.com/gulpjs/gulp/blob/master/docs/recipes/using-external-config-file.md</a></p>
<h4 id="代码结构-1"><a href="#代码结构-1" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">gulpfile.<span class="property">js</span></span><br><span class="line">gulp</span><br><span class="line">├── config.<span class="property">json</span></span><br><span class="line">├── tasks/</span><br><span class="line">    ├── xxxx.<span class="property">js</span></span><br><span class="line">    ├── xxxx.<span class="property">js</span></span><br><span class="line">    └── image.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<p><code>注意：文件夹层次变了</code></p>
<h4 id="config-json"><a href="#config-json" class="headerlink" title="config.json"></a>config.json</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;pnglevel&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="gulpfile-js-2"><a href="#gulpfile-js-2" class="headerlink" title="gulpfile.js"></a>gulpfile.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>)</span><br><span class="line">  , config = <span class="built_in">require</span>(<span class="string">&#x27;./gulp/config.json&#x27;</span>);</span><br><span class="line">  , gulpLoadPlugins = <span class="built_in">require</span>(<span class="string">&#x27;gulp-load-plugins&#x27;</span>)</span><br><span class="line">  , gulpTaskList = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="title function_">readdirSync</span>(<span class="string">&#x27;./gulp/tasks/&#x27;</span>)</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">gulpLoadPlugins.<span class="property">imagemin</span> = <span class="built_in">require</span>(<span class="string">&#x27;gulp-imagemin&#x27;</span>);</span><br><span class="line"></span><br><span class="line">gulpTaskList.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">taskfile</span>) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;./gulp/tasks/&#x27;</span> + taskfile)(gulp, gulpLoadPlugins, config);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="image-js-2"><a href="#image-js-2" class="headerlink" title="image.js"></a>image.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">gulp, Plugin, config</span>) &#123;</span><br><span class="line">  gulp.<span class="title function_">task</span>(<span class="string">&quot;img&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> gulp</span><br><span class="line">      .<span class="title function_">src</span>(<span class="string">&quot;./images/**/*.*&quot;</span>)</span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title class_">Plugin</span>.<span class="title function_">imagemin</span>(&#123;</span><br><span class="line">          <span class="attr">optimizationLevel</span>: config.<span class="property">pnglevel</span>,</span><br><span class="line">          <span class="attr">progressive</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">      .<span class="title function_">pipe</span>(gulp.<span class="title function_">dest</span>(<span class="string">&quot;./imagemini&quot;</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>此次迭代结束后，我把子任务中通用的配置都写到 <code>./gulp/config.json</code> 中，全局配置</p>
<h3 id="5-重构迭代-4-参数配置模块化"><a href="#5-重构迭代-4-参数配置模块化" class="headerlink" title="5 重构迭代 4: 参数配置模块化"></a>5 重构迭代 4: 参数配置模块化</h3><p>此次迭代紧跟迭代 3，<code>json</code> 不够完美，不想每次去写 <code>&quot;&quot;</code>, 这里我把配置文件封装成一个模块</p>
<p>即迭代 3 中的 <code>config.json</code> 变成了 <code>config.js</code></p>
<h4 id="config-js"><a href="#config-js" class="headerlink" title="config.js"></a>config.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">pnglevel</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="gulpfile-js-加载"><a href="#gulpfile-js-加载" class="headerlink" title="gulpfile.js 加载"></a>gulpfile.js 加载</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">&quot;./gulp/gulp.config&quot;</span>)();</span><br></pre></td></tr></table></figure>

<p>其他不变，当封装成一个模块的时候，你就发现好处多多了，可以在模块中添加函数，你也可以把配置拆分，根据你的业务需要，自由调整</p>
<h3 id="6-后记"><a href="#6-后记" class="headerlink" title="6 后记"></a>6 后记</h3><p>通过 4 步的迭代，整个代码组织架构就清晰多了，很感谢这么多热爱开源，乐于助人的朋友，谢谢</p>
<p>注意： 子任务中注意文件夹的层次，子任务中的文件夹是以 <code>gulpfile.js</code> 为基准，因为 <code>gulpfile.js</code> 把子任务都包含进来了</p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>Gulp</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序未找到入口 sitemap.json</title>
    <url>/posts/6541/</url>
    <content><![CDATA[<p><code>Error</code>: 未找到入口 <code>sitemap.json</code> 文件，或者文件读取失败，请检查后重新编译</p>
<span id="more"></span>

<h3 id="1-问题描述"><a href="#1-问题描述" class="headerlink" title="1 问题描述"></a>1 问题描述</h3><p>今天在微信开发者工具中发现了一个错误，这个错误一直没有注意到。</p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">`Error`: 未找到入口 `sitemap.json` 文件，或者文件读取失败，请检查后重新编译</span><br></pre></td></tr></table></figure>

<p>这个错误不会影响小程序的正常使用，查阅了文档（<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/sitemap.html%60">微信小程序 sitemap.json</a>），才知道这个文件是用来给微信小程序搜索建立索引用的，下面再仔细分析下这个功能。</p>
<h3 id="2-解决方法"><a href="#2-解决方法" class="headerlink" title="2 解决方法"></a>2 解决方法</h3><p>第一步：我根据错误描述，在 app.jsx(我使用了 Taro) 同级目录下新建了一个 <code>sitemap.json</code> 文件，内容如下:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>第二步：接着在 <code>app.jsx</code> 中的 <code>config</code> 中添加</p>
<figure class="highlight sml"><table><tr><td class="code"><pre><span class="line">sitemapLocation: <span class="symbol">&#x27;sitemap</span>.json&#x27;,</span><br></pre></td></tr></table></figure>

<p>然后编译测试，发现还是出现同样的错误，然后发现 <code>dist</code> 文件夹下面没有 <code>sitemap.json</code> 文件，这个可能是 <code>Taro</code> 不支持的原因，但是 <code>Taro</code> 还是提供了一个 <code>copy</code> 的编译功能（<a href="https://nervjs.github.io/taro/docs/config-detail.html#copy">Taro 编译配置 copy</a>)，摘出来如下：</p>
<blockquote>
<p>copy</p>
</blockquote>
<p>文件 <code>copy</code> 配置，包含两个配置项 <code>patterns</code> 和 <code>options</code>。</p>
<p><strong>copy.patterns</strong></p>
<p>用来指定需要拷贝的文件或者目录，数组类型，每一项都必须包含 <code>from</code> 、<code>to</code> 的配置，分别代表来源和需要拷贝到的目录，同时可以设置 <code>ignore</code> 配置来指定需要忽略的文件， <code>ignore</code> 是指定的 <code>glob</code> 类型字符串，或者 glob 字符串数组。</p>
<p>值得注意的是，目前 <code>from</code> 必须指定存在的文件或者目录，暂不支持 <code>glob</code> 格式， <code>from</code> 和 <code>to</code> 直接置顶项目根目录下的文件目录，建议 <code>from</code> 以 <code>src</code> 目录开头，<code>to</code> 以 <code>dist</code> 目录开头。</p>
<p>一般有如下的使用形式：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">copy: &#123;</span><br><span class="line">    patterns: [</span><br><span class="line">        &#123; <span class="selector-tag">from</span>: <span class="string">&#x27;src/asset/tt/&#x27;</span>, to: <span class="string">&#x27;dist/asset/tt/&#x27;</span>, ignore: <span class="string">&#x27;*.js&#x27;</span> &#125;, // 指定需要 copy 的目录</span><br><span class="line">        &#123; <span class="selector-tag">from</span>: <span class="string">&#x27;src/asset/tt/sd.jpg&#x27;</span>, to: <span class="string">&#x27;dist/asset/tt/sd.jpg&#x27;</span> &#125; // 指定需要 copy 的文件</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><strong>copy.options</strong></p>
<p>拷贝配置，目前可以指定全局的 <code>ignore</code>：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">copy: &#123;</span><br><span class="line">    options: &#123;</span><br><span class="line">        ignore: [<span class="string">&#x27;*.js&#x27;</span>, <span class="string">&#x27;*.css&#x27;</span>] // 全局的 ignore</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步：好了，看完文档后，直接修改 <code>Taro</code> 的配置文件，添加以下内容：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">copy: &#123;</span><br><span class="line">    patterns: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="selector-tag">from</span>: <span class="string">&#x27;src/sitemap.json&#x27;</span>,</span><br><span class="line">            to: <span class="string">&#x27;dist/sitemap.json&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>再次编译测试，正常，查看 <code>dist</code> 文件夹也存在 <code>sitemap.json</code> 文件。</p>
<h3 id="3-聊下-sitemap"><a href="#3-聊下-sitemap" class="headerlink" title="3 聊下 sitemap"></a>3 聊下 sitemap</h3><p>这个功能不错，增加小程序的曝光度，而且开发者还可以根据业务需要自定义被索引的页面，很实用。如果你不关心这些东西，就参考我的 <code>sitemap.json</code> 配置。</p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>Taro</tag>
        <tag>小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>Debian | Media change please insert the disc labeled</title>
    <url>/posts/20380/</url>
    <content><![CDATA[<p>使用 <code>apt install xxx</code> 时，出现下面的报错</p>
<span id="more"></span>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Media change: please insert the disc labeled</span><br><span class="line"></span><br><span class="line">media change: please insert the disc labeled</span><br><span class="line">Debian 10.9.3 - Release amd64 (20210327.10) in the drive /media/cdrom/ and press enter</span><br></pre></td></tr></table></figure>

<p>查看下 <code>/etc/apt/sources.list</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># deb cdrom:[Debian GNU/Linux 10.9.0 _Buster_ - Official amd64 DVD Binary-1 20210327-10:39]/ buster contrib main</span></span><br><span class="line"></span><br><span class="line">deb cdrom:[Debian GNU/Linux <span class="number">10.9</span><span class="number">.0</span> _Buster_ - Official amd64 DVD Binary-<span class="number">1</span> <span class="number">20210327</span>-<span class="number">10</span>:<span class="number">39</span>]/ buster contrib main</span><br><span class="line"></span><br><span class="line">deb http://security.debian.org/debian-security buster/updates main contrib</span><br><span class="line">deb-src http://security.debian.org/debian-security buster/updates main contrib</span><br><span class="line"></span><br><span class="line"><span class="comment"># buster-updates, previously known as &#x27;volatile&#x27;</span></span><br><span class="line"><span class="comment"># A network mirror was not selected during install.  The following entries</span></span><br><span class="line"><span class="comment"># are provided as examples, but you should amend them as appropriate</span></span><br><span class="line"><span class="comment"># for your mirror of choice.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># deb http://deb.debian.org/debian/ buster-updates main contrib</span></span><br><span class="line"><span class="comment"># deb-src http://deb.debian.org/debian/ buster-updates main contrib</span></span><br></pre></td></tr></table></figure>

<p>果断把包含 <code>deb cdrom</code> 这行给注释掉，然后又重新把 <code>apt</code> 源设置成清华源，修改后的文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># deb cdrom:[Debian GNU/Linux 10.9.0 _Buster_ - Official amd64 DVD Binary-1 20210327-10:39]/ buster contrib main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># deb cdrom:[Debian GNU/Linux 10.9.0 _Buster_ - Official amd64 DVD Binary-1 20210327-10:39]/ buster contrib main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># deb https://security.debian.org/debian-security buster/updates main contrib</span></span><br><span class="line"><span class="comment"># deb-src http://security.debian.org/debian-security buster/updates main contrib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># buster-updates, previously known as &#x27;volatile&#x27;</span></span><br><span class="line"><span class="comment"># A network mirror was not selected during install.  The following entries</span></span><br><span class="line"><span class="comment"># are provided as examples, but you should amend them as appropriate</span></span><br><span class="line"><span class="comment"># for your mirror of choice.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># deb http://deb.debian.org/debian/ buster-updates main contrib</span></span><br><span class="line"><span class="comment"># deb-src http://deb.debian.org/debian/ buster-updates main contrib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br></pre></td></tr></table></figure>

<p>然后执行 <code>apt update</code>，最后重新安装软件成功。</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Debian</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 不同的发行版设置静态 IP</title>
    <url>/posts/29624/</url>
    <content><![CDATA[<p>近来在折腾本地服务器，为了方式每次重启 IP 地址的变化，所以要给机器设置静态 IP <span id="more"></span></p>
<h2 id="一-不同发行版静态-IP-设置"><a href="#一-不同发行版静态-IP-设置" class="headerlink" title="一 不同发行版静态 IP 设置"></a>一 不同发行版静态 IP 设置</h2><h3 id="1-Centos-设置静态-IP"><a href="#1-Centos-设置静态-IP" class="headerlink" title="1 Centos 设置静态 IP"></a>1 Centos 设置静态 IP</h3><h4 id="修改网络配置"><a href="#修改网络配置" class="headerlink" title="修改网络配置"></a>修改网络配置</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>sysconfig<span class="regexp">/network-scripts/i</span>fcfg-eth192</span><br></pre></td></tr></table></figure>

<p>修改后的内容如下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">PROXY_METHOD</span>=none</span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="literal">no</span></span><br><span class="line"><span class="comment"># 这里可以使用 static 或者 no</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=none</span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">IPV6INIT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV6_AUTOCONF</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV6_DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV6_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">IPV6_ADDR_GEN_MODE</span>=stable-privacy</span><br><span class="line"><span class="attr">NAME</span>=ens192</span><br><span class="line"><span class="attr">UUID</span>=cd93f1df-d2d5-<span class="number">4</span>c63-a64c-<span class="number">761</span>e9ee23aae</span><br><span class="line"><span class="attr">DEVICE</span>=ens192</span><br><span class="line"><span class="comment"># 开机启用此配置</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="comment"># 静态 IP</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">192.168</span>.<span class="number">1.12</span></span><br><span class="line"><span class="comment"># 默认网关</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="number">192.168</span>.<span class="number">1.1</span></span><br></pre></td></tr></table></figure>

<h4 id="重启网络服务"><a href="#重启网络服务" class="headerlink" title="重启网络服务"></a>重启网络服务</h4><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">systemctl restart network</span></span><br></pre></td></tr></table></figure>

<h4 id="查看地址"><a href="#查看地址" class="headerlink" title="查看地址"></a>查看地址</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[isproot@192 ~]$ ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:51:63:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.12/24 brd 192.168.1.255 scope global noprefixroute ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2408:8256:a80:313:6ba6:7ad0:edd0:defe/64 scope global noprefixroute dynamic</span><br><span class="line">       valid_lft 183241sec preferred_lft 96841sec</span><br><span class="line">    inet6 fe80::b6f3:1daa:4b7b:6994/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="2-Debian-设置静态-IP"><a href="#2-Debian-设置静态-IP" class="headerlink" title="2 Debian 设置静态 IP"></a>2 Debian 设置静态 IP</h3><h4 id="修改网络配置-1"><a href="#修改网络配置-1" class="headerlink" title="修改网络配置"></a>修改网络配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/network/interfaces</span><br></pre></td></tr></table></figure>

<p>修改后的内容如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and how to activate them. For more information, see interfaces(5).</span></span><br><span class="line"></span><br><span class="line">source /etc/network/interfaces.d/*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The loopback network interface</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The primary network interface</span></span><br><span class="line">allow-hotplug ens192</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">iface ens192 inet dhcp</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置成静态 IP</span></span><br><span class="line">iface ens192 inet static</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 IP</span></span><br><span class="line">address 192.168.1.11</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置子网掩码</span></span><br><span class="line">netmask 255.255.255.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置网关</span></span><br><span class="line">gateway 192.168.1.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 DNS 服务器，我这里设置成路由器的地址</span></span><br><span class="line">dns-nameservers 192.168.1.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is an autoconfigured IPv6 interface</span></span><br><span class="line">iface ens192 inet6 auto</span><br></pre></td></tr></table></figure>

<h4 id="重启网络服务-1"><a href="#重启网络服务-1" class="headerlink" title="重启网络服务"></a>重启网络服务</h4><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">service networking restart</span></span><br></pre></td></tr></table></figure>

<h4 id="查看地址-1"><a href="#查看地址-1" class="headerlink" title="查看地址"></a>查看地址</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@debian:~# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:0a:14:07 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2408:8256:a81:c14f:20c:29ff:fe0a:1407/64 scope global dynamic mngtmpaddr</span><br><span class="line">       valid_lft 206755sec preferred_lft 120355sec</span><br><span class="line">    inet6 fe80::20c:29ff:fe0a:1407/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="二-小结"><a href="#二-小结" class="headerlink" title="二 小结"></a>二 小结</h2><p>从配置的过程来看，基本上都是配置文件的目录和配置项不同而已，其他基本上都差不多，毕竟原理都是一样的。</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Debian</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux | 查看服务器登录用户的活动情况</title>
    <url>/posts/10000/</url>
    <content><![CDATA[<p>为了安全，会经常性的查看服务器登录的用户的情况，下面列举常用命令的使用<span id="more"></span></p>
<h2 id="1-utmp-wtmp-btmp-文件"><a href="#1-utmp-wtmp-btmp-文件" class="headerlink" title="1 utmp wtmp btmp 文件"></a>1 utmp wtmp btmp 文件</h2><p>这里做个前置说明，因为接下来的很多命令都与这些文件有着千丝万缕的关系。</p>
<h3 id="1-1-文件说明"><a href="#1-1-文件说明" class="headerlink" title="1.1 文件说明"></a>1.1 文件说明</h3><p>Linux 用户登录的信息一般放在了这三个中。</p>
<ul>
<li><code>/var/run/utmp</code>：记录当前正在登录系统的用户信息，<code>who</code> 和 <code>w</code>，<code>uptime</code> 命令默认依赖此文件</li>
<li><code>/var/log/wtmp</code>：记录登录过此系统的用户信息，包括现在和过去（其实就是记录 utmp 文件的历史记录），默认由 <code>last</code> 命令查看。</li>
<li><code>/var/log/btmp</code>：记录失败的尝试登录信息（这个也囊括了恶意的尝试暴力登录的尝试)，默认由 <code>lastb</code> 命令查看。</li>
</ul>
<p>这三个文件都是二进制文件，并且这三个文件结构完全相同，结构体的定义在 <code>/usr/include/utmp.h</code> 文件中。</p>
<h3 id="1-2-logrotate"><a href="#1-2-logrotate" class="headerlink" title="1.2 logrotate"></a>1.2 logrotate</h3><p>默认情况下，文件的日志信息会通过 <code>logrotate</code> 日志管理工具定期清理，<code>logrotate</code> 的配置文件（<code>/etc/logrotate.conf</code>)，其是 <code>logrotate</code> 的缺省配置。</p>
<p>通常情况下不需要对它进行修改。日志文件的轮循压缩等配置存放在独立的配置文件中，它们位置是：<code>/etc/logrotate.d/</code> 目录下，他会覆盖缺省配置。</p>
<p>如果不想记录相关信息，则可以直接删除相关的配置文件。如果系统不存在改文件，则新建一个配置文件即可。这里看下默认的系统日志配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict logrotate.d]# cat syslog</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/maillog</span><br><span class="line">/var/log/messages</span><br><span class="line">/var/log/secure</span><br><span class="line">/var/log/spooler</span><br><span class="line">&#123;</span><br><span class="line">    missingok</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">	/bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-注意细节"><a href="#1-3-注意细节" class="headerlink" title="1.3 注意细节"></a>1.3 注意细节</h3><p>上面为什么说 <code>/var/log/wtmp</code> 其实是记录 <code>/var/run/utmp</code> 文件的历史记录呢，通过内容对下下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict bits]# utmpdump /var/run/utmp</span><br><span class="line">Utmp dump of /var/run/utmp</span><br><span class="line">[2] [00000] [~~  ] [reboot  ] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 23:54:09 2018   ]</span><br><span class="line">[1] [00051] [~~  ] [runlevel] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[6] [01060] [tty1] [LOGIN   ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[6] [01059] [tyS0] [LOGIN   ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[7] [14985] [ts/0] [root    ] [pts/0       ] [121.32.197.136      ] [121.32.197.136 ] [一 7月 18 10:59:15 2018   ]</span><br><span class="line"></span><br><span class="line">[root@kycool-strict bits]# utmpdump /var/log/wtmp</span><br><span class="line">Utmp dump of /var/log/wtmp</span><br><span class="line">[8] [01088] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2018   ]</span><br><span class="line">[8] [01089] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2018   ]</span><br><span class="line">[2] [00000] [~~  ] [reboot  ] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 23:54:09 2018   ]</span><br><span class="line">[1] [00051] [~~  ] [runlevel] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[5] [01060] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[5] [01059] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[6] [01060] [tty1] [LOGIN   ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[6] [01059] [tyS0] [LOGIN   ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2018   ]</span><br><span class="line">[7] [01379] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:55:51 2018   ]</span><br><span class="line">[8] [01377] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:56:27 2018   ]</span><br><span class="line">[7] [01404] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:56:29 2018   ]</span><br><span class="line">[8] [01402] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 16:03:01 2018   ]</span><br><span class="line">[7] [01589] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 16:04:39 2018   ]</span><br><span class="line">[8] [01587] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 20:12:05 2018   ]</span><br><span class="line">[7] [04064] [ts/0] [root    ] [pts/0       ] [121.32.199.178      ] [121.32.199.178 ] [二 7月 12 15:03:05 2018   ]</span><br><span class="line">[8] [04062] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [二 7月 12 17:26:21 2018   ]</span><br><span class="line">[7] [14985] [ts/0] [root    ] [pts/0       ] [121.32.197.136      ] [121.32.197.136 ] [一 7月 18 10:59:15 2018   ]</span><br></pre></td></tr></table></figure>

<h2 id="2-常用命令"><a href="#2-常用命令" class="headerlink" title="2 常用命令"></a>2 常用命令</h2><h3 id="2-1-w"><a href="#2-1-w" class="headerlink" title="2.1 w"></a>2.1 w</h3><p>查看当前登入系统的用户信息及用户当前的线程。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict ~]# w</span><br><span class="line"></span><br><span class="line"> 11:09:28 up 18 days, 19:15,  1 user,  load average: 0.00, 0.01, 0.05</span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">root     pts/0    121.32.197.136   10:59    0.00s  0.00s  0.00s w</span><br></pre></td></tr></table></figure>

<p>输出解释：<br><strong>上半部分</strong><br><code>11:09:28 up 18 days, 19:15, 1 user, load average: 0.00, 0.01, 0.05</code><br>这里其实类似于 <code>top</code> 的第一行，显示了当前的系统时间，开机运行多久（<code>up</code>），有多少用户登录（<code>users</code>），<br>以及 <code>1</code> 分钟，<code>5</code> 分钟，<code>15</code> 分钟前的平均负载（<code>load average</code>）。</p>
<p><strong>下半部分</strong><br>下班部分类似于表格，这就就简述下表头的含义</p>
<ul>
<li><code>USER</code>：登录的用户名</li>
<li><code>TTY</code>：登录的终端</li>
<li><code>FROM</code>：用户从哪个 IP 地址进行登录</li>
<li><code>LOGIN@</code>：登录时间</li>
<li><code>IDLE</code>：用户闲置时间</li>
<li><code>JCPU</code>：处于该终端连接下的所有进程占用的 CPU 运算时间。这个时间不包含过去的后台作业时间，但是<br>包括当前正在运行的后台作业时间</li>
<li><code>PCPU</code>：当前进程所占用的 CPU 运算时间</li>
<li><code>WHAT</code>：当前正在运行的命令</li>
</ul>
<h3 id="2-2-who"><a href="#2-2-who" class="headerlink" title="2.2 who"></a>2.2 who</h3><p>查看当前登录用户的情况</p>
<p>当不指定任何参数时，将按照以下顺序打印信息：<br><strong>登录用户名称，终端信息，登录时间，用户登录 IP 地址</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict ~]# who</span><br><span class="line">root     pts/0        2018-07-18 10:59 (112.22.194.16)</span><br></pre></td></tr></table></figure>

<p>通过 man who 时，发现了一句话：</p>
<p><code>If FILE is not specified, use /var/run/utmp. /var/log/wtmp as FILE is common.</code></p>
<p>即如果不指定文件，默认使用 <code>/var/run/utmp</code> 文件，当前也可以指定文件，进行查看</p>
<p>下面使用 <code>wtmp</code> 文件进行查看</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict ~]<span class="comment"># who /var/log/wtmp</span></span><br><span class="line">root pts/<span class="number">0</span> <span class="number">2018</span>-06-<span class="number">29</span> <span class="number">15</span>:<span class="number">55</span> (<span class="number">113.65</span><span class="number">.29</span><span class="number">.194</span>)</span><br><span class="line">root pts/<span class="number">0</span> <span class="number">2018</span>-06-<span class="number">29</span> <span class="number">15</span>:<span class="number">56</span> (<span class="number">113.65</span><span class="number">.29</span><span class="number">.194</span>)</span><br><span class="line">root pts/<span class="number">0</span> <span class="number">2018</span>-06-<span class="number">29</span> <span class="number">16</span>:04 (<span class="number">113.65</span><span class="number">.29</span><span class="number">.194</span>)</span><br><span class="line">root pts/<span class="number">0</span> <span class="number">2018</span>-07-<span class="number">12</span> <span class="number">15</span>:03 (<span class="number">121.32</span><span class="number">.199</span><span class="number">.178</span>)</span><br><span class="line">root pts/<span class="number">0</span> <span class="number">2018</span>-07-<span class="number">18</span> <span class="number">10</span>:<span class="number">59</span> (<span class="number">121.32</span><span class="number">.197</span><span class="number">.136</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里看到了过去，现在登录用户的情况</p>
<h3 id="2-3-users"><a href="#2-3-users" class="headerlink" title="2.3 users"></a>2.3 users</h3><p>查看当前服务器所有登录用户的情况，更详细的可以查看手册。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict ~]# users</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h3 id="2-4-lastlog"><a href="#2-4-lastlog" class="headerlink" title="2.4 lastlog"></a>2.4 lastlog</h3><p>列出所有用户最近登录的信息，或者指定用户的最近登录信息。其引用的文件是：<code>/var/log/lastlog</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# lastlog</span><br><span class="line">用户名           端口     来自             最后登陆时间</span><br><span class="line">future          pts/0    121.32.197.136   一 7月 18 10:59:15 +0800 2022</span><br><span class="line">bin                                        **从未登录过**</span><br><span class="line">daemon                                     **从未登录过**</span><br><span class="line">adm                                        **从未登录过**</span><br><span class="line">lp                                         **从未登录过**</span><br><span class="line">sync                                       **从未登录过**</span><br><span class="line">shutdown                                   **从未登录过**</span><br><span class="line">halt                                       **从未登录过**</span><br><span class="line">mail                                       **从未登录过**</span><br><span class="line">operator                                   **从未登录过**</span><br></pre></td></tr></table></figure>

<h3 id="3-5-last"><a href="#3-5-last" class="headerlink" title="3.5 last"></a>3.5 last</h3><p>列出当前和曾经登录系统的用户信息。默认读取 <code>/var/log/wtmp</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# last</span><br><span class="line">root     pts/0        121.32.197.136   Mon Jul 18 10:59   still logged in</span><br><span class="line">root     pts/0        121.32.199.178   Tue Jul 12 15:03 - 17:26  (02:23)</span><br><span class="line">root     pts/0        113.65.29.194    Wed Jun 29 16:04 - 20:12  (04:07)</span><br><span class="line">root     pts/0        113.65.29.194    Wed Jun 29 15:56 - 16:03  (00:06)</span><br><span class="line">root     pts/0        113.65.29.194    Wed Jun 29 15:55 - 15:56  (00:00)</span><br><span class="line">reboot   system boot  3.10.0-1160.66.1 Wed Jun 29 23:54 - 13:54 (18+14:00)</span><br></pre></td></tr></table></figure>

<p>当然，也可以通过 <code>last -f</code> 参数指定读取文件，可以是 <code>/var/log/btmp</code>，<code>/var/run/utmp</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# last -f /var/run/utmp</span><br><span class="line">root     pts/0        121.32.197.136   Mon Jul 18 10:59   still logged in</span><br><span class="line">reboot   system boot  3.10.0-1160.66.1 Wed Jun 29 23:54 - 13:55 (18+14:01)</span><br><span class="line"></span><br><span class="line">utmp begins Wed Jun 29 23:54:09 2022</span><br></pre></td></tr></table></figure>

<h3 id="3-6-lastb"><a href="#3-6-lastb" class="headerlink" title="3.6 lastb"></a>3.6 lastb</h3><p>列出失败的尝试登陆信息，和 last 命令功能相同，不过默认读取的文件是：<code>/var/log/btmp</code>。<br>当然也可以通过 <code>-f</code> 参数指定其他的读取文件。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# lastb -n 20</span><br><span class="line">avorion  ssh:notty    150.185.5.6      Mon Jul 18 13:25 - 13:25  (00:00)</span><br><span class="line">admin    ssh:notty    109.197.194.157  Mon Jul 18 13:18 - 13:18  (00:00)</span><br><span class="line">admin    ssh:notty    150.185.10.122   Mon Jul 18 13:18 - 13:18  (00:00)</span><br><span class="line">lucas    ssh:notty    103.169.34.130   Mon Jul 18 12:57 - 12:57  (00:00)</span><br><span class="line">abby     ssh:notty    193.122.108.42   Mon Jul 18 12:55 - 12:55  (00:00)</span><br><span class="line">nick     ssh:notty    195.218.137.42   Mon Jul 18 12:53 - 12:53  (00:00)</span><br><span class="line">anurag   ssh:notty    43.128.104.254   Mon Jul 18 12:40 - 12:40  (00:00)</span><br><span class="line">admin    ssh:notty    206.189.87.108   Mon Jul 18 12:32 - 12:32  (00:00)</span><br><span class="line">testuser ssh:notty    192.3.211.39     Mon Jul 18 12:31 - 12:31  (00:00)</span><br><span class="line">quagga   ssh:notty    118.27.36.26     Mon Jul 18 12:30 - 12:30  (00:00)</span><br><span class="line">ismael   ssh:notty    175.47.205.72    Mon Jul 18 12:28 - 12:28  (00:00)</span><br><span class="line">tanya    ssh:notty    62.64.86.44      Mon Jul 18 12:26 - 12:26  (00:00)</span><br><span class="line">weixin   ssh:notty    218.111.88.185   Mon Jul 18 12:25 - 12:25  (00:00)</span><br><span class="line">bob      ssh:notty    121.26.142.238   Mon Jul 18 11:29 - 11:29  (00:00)</span><br><span class="line">test03   ssh:notty    190.147.165.61   Mon Jul 18 11:25 - 11:25  (00:00)</span><br><span class="line">ubuntu   ssh:notty    107.184.205.109  Mon Jul 18 10:33 - 10:33  (00:00)</span><br><span class="line">cafe24   ssh:notty    190.246.155.29   Mon Jul 18 10:11 - 10:11  (00:00)</span><br><span class="line">upload   ssh:notty    196.20.68.81     Mon Jul 18 10:09 - 10:09  (00:00)</span><br><span class="line">postgres ssh:notty    202.29.13.51     Mon Jul 18 10:07 - 10:07  (00:00)</span><br><span class="line">scanner  ssh:notty    111.67.197.134   Mon Jul 18 08:18 - 08:18  (00:00)</span><br></pre></td></tr></table></figure>

<p>通过日志，可以看到存在 <code>ssh</code> 暴力破解的情况。</p>
<h3 id="3-7-utmpdump"><a href="#3-7-utmpdump" class="headerlink" title="3.7 utmpdump"></a>3.7 utmpdump</h3><p>用于转储二进制日志文件到文本格式的的文件以便查看，同时也可以修改二进制文件。包括</p>
<ul>
<li><code>/var/run/utmp</code></li>
<li><code>/var/log/wtmp</code></li>
<li><code>/var/log/btmp</code></li>
</ul>
<p>修改文件可以篡改记录，所以权限一定要严格限定，防止非法操作，例如篡改 <code>wtmp</code> 文件中的登录地址，祸水东引。</p>
<p>查看 <code>wtmp</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# utmpdump wtmp</span><br><span class="line">Utmp dump of wtmp</span><br><span class="line">[8] [01088] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2022   ]</span><br><span class="line">[8] [01089] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2022   ]</span><br><span class="line">[2] [00000] [~~  ] [reboot  ] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 23:54:09 2022   ]</span><br><span class="line">[1] [00051] [~~  ] [runlevel] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[5] [01060] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[5] [01059] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[6] [01060] [tty1] [LOGIN   ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[6] [01059] [tyS0] [LOGIN   ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[7] [01379] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:55:51 2022   ]</span><br><span class="line">[8] [01377] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:56:27 2022   ]</span><br><span class="line">[7] [01404] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:56:29 2022   ]</span><br><span class="line">[8] [01402] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 16:03:01 2022   ]</span><br><span class="line">[7] [01589] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 16:04:39 2022   ]</span><br><span class="line">[8] [01587] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 20:12:05 2022   ]</span><br><span class="line">[7] [04064] [ts/0] [root    ] [pts/0       ] [121.32.199.178      ] [121.32.199.178 ] [二 7月 12 15:03:05 2022   ]</span><br><span class="line">[8] [04062] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [二 7月 12 17:26:21 2022   ]</span><br><span class="line">[7] [14985] [ts/0] [root    ] [pts/0       ] [121.32.197.136      ] [121.32.197.136 ] [一 7月 18 10:59:15 2022   ]</span><br></pre></td></tr></table></figure>

<p>模拟修改最后一行的 <code>IP</code> 地址，把 <code>121.32.197.136</code> 修改为 <code>121.32.197.122</code></p>
<p><strong>第一步：导出文本信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# utmpdump wtmp &gt; tmp_wtmp</span><br><span class="line">Utmp dump of wtmp</span><br></pre></td></tr></table></figure>

<p><strong>第二步：修改 tmp_wtmp 文件</strong></p>
<p>将 <code>121.32.197.136</code> 修改为 <code>121.32.197.122</code></p>
<p><strong>第三步：覆盖源文件</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# utmpdump -r tmp_wtmp &gt; wtmp</span><br><span class="line">Utmp undump of tmp_wtmp</span><br></pre></td></tr></table></figure>

<p><strong>第四步：再次查看，进行确认</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@kycool-strict log]# utmpdump wtmp</span><br><span class="line">Utmp dump of wtmp</span><br><span class="line">[8] [01088] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2022   ]</span><br><span class="line">[8] [01089] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 5月 25 10:46:00 2022   ]</span><br><span class="line">[2] [00000] [~~  ] [reboot  ] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 23:54:09 2022   ]</span><br><span class="line">[1] [00051] [~~  ] [runlevel] [~           ] [3.10.0-1160.66.1.el7.x86_64] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[5] [01060] [tty1] [        ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[5] [01059] [tyS0] [        ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[6] [01060] [tty1] [LOGIN   ] [tty1        ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[6] [01059] [tyS0] [LOGIN   ] [ttyS0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:54:19 2022   ]</span><br><span class="line">[7] [01379] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:55:51 2022   ]</span><br><span class="line">[8] [01377] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 15:56:27 2022   ]</span><br><span class="line">[7] [01404] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 15:56:29 2022   ]</span><br><span class="line">[8] [01402] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 16:03:01 2022   ]</span><br><span class="line">[7] [01589] [ts/0] [root    ] [pts/0       ] [113.65.29.194       ] [113.65.29.194  ] [三 6月 29 16:04:39 2022   ]</span><br><span class="line">[8] [01587] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [三 6月 29 20:12:05 2022   ]</span><br><span class="line">[7] [04064] [ts/0] [root    ] [pts/0       ] [121.32.199.178      ] [121.32.199.178 ] [二 7月 12 15:03:05 2022   ]</span><br><span class="line">[8] [04062] [    ] [        ] [pts/0       ] [                    ] [0.0.0.0        ] [二 7月 12 17:26:21 2022   ]</span><br><span class="line">[7] [14985] [ts/0] [root    ] [pts/0       ] [121.32.197.122      ] [121.32.197.122 ] [一 7月 18 10:59:15 2022   ]</span><br></pre></td></tr></table></figure>

<p>最后一行中的 <code>IP</code> 地址已经变成了 <code>121.32.197.122</code></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title>简单备份文件并发送到指定邮箱</title>
    <url>/posts/13676/</url>
    <content><![CDATA[<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h3><p>一哥们发了个诉求，总觉得自己的服务器不安全，想搞个定时备份文件并发送到自己的邮箱</p>
<span id="more"></span>

<h3 id="2-实现代码如下"><a href="#2-实现代码如下" class="headerlink" title="2 实现代码如下"></a>2 实现代码如下</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, unicode_literals</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"><span class="keyword">from</span> email.mime.application <span class="keyword">import</span> MIMEApplication</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"></span><br><span class="line">name = datetime.datetime.now().strftime(<span class="string">&quot;%Y%m%d%H%M%S&quot;</span>)</span><br><span class="line">base_path = <span class="string">&#x27;/root/xxxx/temp&#x27;</span></span><br><span class="line">zip_path = <span class="string">&#x27;/root/xxxx/backup/&#123;&#125;.tar.bz2&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_logging</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    log_dir, log_file = <span class="string">&#x27;/root/xxxx/logs&#x27;</span>, <span class="string">&#x27;/root/xxxx/logs/backup.log&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.mkdir(log_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_file):</span><br><span class="line">        <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    DEFAULT_LOGGING = &#123;</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">        <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;formatone&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;[%(asctime)s] %(levelname)s : %(message)s&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;/root/xxxx/logs/backup.log&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;formatone&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;maxBytes&#x27;</span>: <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">                <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;backup&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logging.config.dictConfig(DEFAULT_LOGGING)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zip_files</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;zip files&quot;&quot;&quot;</span></span><br><span class="line">    os.system(<span class="string">&#x27;tar -cjf &#123;&#125; -C &#123;&#125; data&#x27;</span>.<span class="built_in">format</span>(zip_path, base_path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendmail</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;send mail&quot;&quot;&quot;</span></span><br><span class="line">    set_logging()</span><br><span class="line">    zip_files()</span><br><span class="line"></span><br><span class="line">    logger = logging.getLogger(<span class="string">&#x27;backup&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    mail_from, password = <span class="string">&#x27;xxxxxxx@aliyun.com&#x27;</span>, <span class="string">&#x27;xxxxxxx&#x27;</span></span><br><span class="line">    mail_to = <span class="string">&#x27;xxxxx@qq.com&#x27;</span></span><br><span class="line">    smtp_server = <span class="string">&#x27;smtp.aliyun.com&#x27;</span></span><br><span class="line"></span><br><span class="line">    msgRoot = MIMEMultipart(<span class="string">&#x27;related&#x27;</span>)</span><br><span class="line">    msgRoot[<span class="string">&#x27;Subject&#x27;</span>] = <span class="string">&#x27;send backup files &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">    msgRoot[<span class="string">&#x27;From&#x27;</span>] = <span class="string">&#x27;&#123;&#125;&lt;&#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(Header(<span class="string">&#x27;backup&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>), mail_from)</span><br><span class="line">    msgRoot[<span class="string">&#x27;To&#x27;</span>] = mail_to</span><br><span class="line"></span><br><span class="line">    msgText = MIMEText(<span class="string">&#x27;backup files&#x27;</span>, <span class="string">&#x27;plain&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    msgRoot.attach(msgText)</span><br><span class="line"></span><br><span class="line">    zip_con = MIMEApplication(<span class="built_in">open</span>(zip_path,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">    zip_con.add_header(<span class="string">&#x27;Content-Disposition&#x27;</span>, <span class="string">&#x27;attachment&#x27;</span>,</span><br><span class="line">                       filename=<span class="string">&#x27;&#123;&#125;.tar.bz2&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">    msgRoot.attach(zip_con)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server = smtplib.SMTP_SSL(smtp_server)</span><br><span class="line">        server.login(mail_from, password)</span><br><span class="line">        server.sendmail(mail_from, mail_to, msgRoot.as_string())</span><br><span class="line">        server.quit()</span><br><span class="line">        logger.info(<span class="string">&#x27;send &#123;&#125; backup files success&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.error(<span class="string">&#x27;send &#123;&#125; failed &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name, e))</span><br><span class="line">        sendmail()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sendmail()</span><br></pre></td></tr></table></figure>

<h3 id="3-简单说明"><a href="#3-简单说明" class="headerlink" title="3 简单说明"></a>3 简单说明</h3><h4 id="3-1-打包文件"><a href="#3-1-打包文件" class="headerlink" title="3.1 打包文件"></a>3.1 打包文件</h4><p>这个实现比较初级，直接用 <code>shell</code> 命令进行打包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">zip_files</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;zip files&quot;&quot;&quot;</span></span><br><span class="line">    os.system(<span class="string">&#x27;tar -cjf &#123;&#125; -C &#123;&#125; data&#x27;</span>.<span class="built_in">format</span>(zip_path, base_path))</span><br></pre></td></tr></table></figure>

<h4 id="3-2-发送邮件"><a href="#3-2-发送邮件" class="headerlink" title="3.2 发送邮件"></a>3.2 发送邮件</h4><p>这个就不说了，现成的模块直接拿来用</p>
<h4 id="3-3-日志记录"><a href="#3-3-日志记录" class="headerlink" title="3.3 日志记录"></a>3.3 日志记录</h4><p>加上日志，可以很清楚的让我知道发送情况如下，示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span>,<span class="number">251</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414000001</span> backup files success</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">03</span>:<span class="number">00</span>:<span class="number">02</span>,<span class="number">620</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414030001</span> backup files success</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">06</span>:<span class="number">00</span>:<span class="number">02</span>,<span class="number">406</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414060001</span> backup files success</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">09</span>:<span class="number">00</span>:<span class="number">02</span>,<span class="number">349</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414090001</span> backup files success</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">02</span>,<span class="number">299</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414120001</span> backup files success</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">01</span>:<span class="number">04</span>,<span class="number">696</span>] <span class="variable constant_">ERROR</span> : send <span class="number">20170414150001</span> failed [<span class="title class_">Errno</span> <span class="number">110</span>] <span class="title class_">Connection</span> timed out</span><br><span class="line">[<span class="number">2017</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">01</span>:<span class="number">05</span>,<span class="number">401</span>] <span class="variable constant_">INFO</span> : send <span class="number">20170414150001</span> backup files success</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-4-定时处理"><a href="#3-4-定时处理" class="headerlink" title="3.4 定时处理"></a>3.4 定时处理</h4><p>定时这个处理，直接使用 <code>crontab</code> 命令，创建个 <code>backup_cron</code> 文件，写入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0 */3 * * *  python /root/xxxxx/backup.py</span><br></pre></td></tr></table></figure>

<h3 id="4-简单小结"><a href="#4-简单小结" class="headerlink" title="4 简单小结"></a>4 简单小结</h3><p>业务比较简单，实现也比较简单，没啥可说的</p>
]]></content>
      <categories>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Django | Mysql 返回不合法的日期时间对象</title>
    <url>/posts/26483/</url>
    <content><![CDATA[<h3 id="1-错误描述"><a href="#1-错误描述" class="headerlink" title="1 错误描述"></a>1 错误描述</h3><p>在查询数据集中的日期时间对象时</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">38</span>]: Device.objects.datetimes(<span class="string">&#x27;latest_alarm_time&#x27;</span>, <span class="string">&#x27;month&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">38</span>]: SELECT DISTINCT</span><br><span class="line">CAST(DATE_FORMAT(CONVERT_TZ(`device_device`.`latest_alarm_time`, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>), <span class="string">&#x27;%Y-%m-01 00:00:00&#x27;</span>) AS DATETIME) AS `datetimefield` FROM `device_device` WHERE `device_device`.`latest_alarm_time` IS NOT NULL ORDER BY `datetimefield` ASC LIMIT <span class="number">21</span></span><br></pre></td></tr></table></figure>

<p>然后报错</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ValueError: Database returned an invalid datetime value. Are time zone definitions <span class="keyword">for</span> your database installed?</span><br></pre></td></tr></table></figure>

<h3 id="2-解决问题"><a href="#2-解决问题" class="headerlink" title="2 解决问题"></a>2 解决问题</h3><p>实际情况，数据库中是有数据，目测月份提取失败；到 mysql 执行了下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mysql root@localhost:py365&gt; select convert_tz(<span class="string">&#x27;2018-05-10 12:30:00&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line">+-------------------------------------------------------------+</span><br><span class="line">| convert_tz(<span class="string">&#x27;2018-05-10 12:30:00&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>)   |</span><br><span class="line">|-------------------------------------------------------------|</span><br><span class="line">| NULL                                                        |</span><br><span class="line">+-------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>果然，结果返回令人诧异的 <code>NULL</code></p>
<p>看了下 Django orm 的 datetimes 官方文档</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Note</span><br><span class="line">This function performs time zone conversions directly <span class="keyword">in</span> the database. As a consequence, your database must be able to interpret the value of tzinfo.tzname(<span class="literal">None</span>). This translates into the following requirements:</span><br><span class="line"></span><br><span class="line">SQLite: no requirements. Conversions are performed <span class="keyword">in</span> Python <span class="keyword">with</span> pytz (installed when you install Django).</span><br><span class="line">PostgreSQL: no requirements (see Time Zones).</span><br><span class="line">Oracle: no requirements (see Choosing a Time Zone File).</span><br><span class="line">MySQL: load the time zone tables <span class="keyword">with</span> mysql_tzinfo_to_sql.</span><br></pre></td></tr></table></figure>

<p>即 mysql 需要使用 mysql_tzinfo_to_sql 载入时区表，接着跳到 <a href="https://dev.mysql.com/doc/refman/8.0/en/mysql-tzinfo-to-sql.html">https://dev.mysql.com/doc/refman/8.0/en/mysql-tzinfo-to-sql.html</a></p>
<p>按照 mysql 官方的文档</p>
<p><code>For the first invocation syntax, pass the zoneinfo directory path name to mysql_tzinfo_to_sql and send the output into the mysql program. For example:</code></p>
<p>我需要按照以下命令执行</p>
<blockquote>
<p>mysql_tzinfo_to_sql &#x2F;usr&#x2F;share&#x2F;zoneinfo | mysql -u root mysql</p>
</blockquote>
<p>然后再次执行上面执行过的转换语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mysql root@localhost:py365&gt; select convert_tz(<span class="string">&#x27;2018-05-10 12:30:00&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line">+-------------------------------------------------------------+</span><br><span class="line">| convert_tz(<span class="string">&#x27;2018-05-10 12:30:00&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>)   |</span><br><span class="line">|-------------------------------------------------------------|</span><br><span class="line">| <span class="number">2018</span>-05-<span class="number">10</span> <span class="number">20</span>:<span class="number">30</span>:<span class="number">00</span>                                         |</span><br><span class="line">+-------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>yes，返回了正确的结果；</p>
<p>在 shell 中 执行数据库查询语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">45</span>]: Device.objects.datetimes(<span class="string">&#x27;latest_alarm_time&#x27;</span>, <span class="string">&#x27;month&#x27;</span>)</span><br><span class="line">Out[<span class="number">45</span>]: SELECT DISTINCT CAST(DATE_FORMAT(CONVERT_TZ(`device_device`.`latest_alarm_time`, <span class="string">&#x27;UTC&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>), <span class="string">&#x27;%Y-%m-01 00:00:00&#x27;</span>) AS DATETIME) AS `datetimefield` FROM `device_device` WHERE `device_device`.`latest_alarm_time` IS NOT NULL ORDER BY `datetimefield` ASC LIMIT <span class="number">21</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Execution time: <span class="number">0.000591</span>s [Database: default]</span><br><span class="line"></span><br><span class="line">&lt;QuerySet [datetime.datetime(<span class="number">2018</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, tzinfo=&lt;DstTzInfo <span class="string">&#x27;Asia/Shanghai&#x27;</span> CST+<span class="number">8</span>:<span class="number">00</span>:<span class="number">00</span> STD&gt;)]&gt;</span><br></pre></td></tr></table></figure>

<p>正常，so 问题解决，看来还得认真看文档呀</p>
]]></content>
      <categories>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Django | 通用的开发包</title>
    <url>/posts/51719/</url>
    <content><![CDATA[<p>更新时间：2019-12-20 22:05:03</p>
<p>基于 <code>Django</code> 项目，通用的第三方开发工具包，这里只列出了通用的开发包，也包含了部分业务包，其他常见的涉及到具体的业务包，不再一一列出。</p>
<h4 id="1-DjangoRestFramework"><a href="#1-DjangoRestFramework" class="headerlink" title="1 DjangoRestFramework"></a>1 DjangoRestFramework</h4><p><a href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a></p>
<p>开发 <code>Restful</code> 接口的主力工具</p>
<h4 id="2-django-cors-headers"><a href="#2-django-cors-headers" class="headerlink" title="2 django-cors-headers"></a>2 django-cors-headers</h4><p><a href="https://github.com/adamchainz/django-cors-headers">https://github.com/adamchainz/django-cors-headers</a></p>
<p>解决前后端分离接口请求跨域</p>
<h4 id="3-django-extensions"><a href="#3-django-extensions" class="headerlink" title="3 django-extensions"></a>3 django-extensions</h4><p><a href="https://github.com/django-extensions/django-extensions">https://github.com/django-extensions/django-extensions</a></p>
<p><code>Django</code> 扩展增强工具</p>
<h4 id="4-ipython"><a href="#4-ipython" class="headerlink" title="4 ipython"></a>4 ipython</h4><p><a href="https://ipython.org/">https://ipython.org/</a></p>
<p>强大的交互式 <code>shell</code>，测试调试非常顺手，当然不仅仅限于 <code>Django</code> 开发</p>
<h4 id="5-django-environ"><a href="#5-django-environ" class="headerlink" title="5 django-environ"></a>5 django-environ</h4><p><a href="https://github.com/joke2k/django-environ">https://github.com/joke2k/django-environ</a></p>
<p>区分各种环境的配置利器</p>
<h4 id="6-celery"><a href="#6-celery" class="headerlink" title="6 celery"></a>6 celery</h4><p><a href="https://github.com/celery/celery">https://github.com/celery/celery</a></p>
<p>分布式的任务队列分发器</p>
<h4 id="7-wechatpy"><a href="#7-wechatpy" class="headerlink" title="7 wechatpy"></a>7 wechatpy</h4><p><a href="https://github.com/wechatpy/wechatpy">https://github.com/wechatpy/wechatpy</a></p>
<p>微信开发必备的 SDK</p>
<h4 id="8-gunicorn"><a href="#8-gunicorn" class="headerlink" title="8 gunicorn"></a>8 gunicorn</h4><p><a href="https://gunicorn.org/">https://gunicorn.org/</a></p>
<p><code>Python WSGI HTTP Server</code></p>
<h4 id="9-factory-boy"><a href="#9-factory-boy" class="headerlink" title="9 factory-boy"></a>9 factory-boy</h4><p><a href="https://github.com/FactoryBoy/factory_boy">https://github.com/FactoryBoy/factory_boy</a></p>
<p>测试数据生成工具</p>
<h4 id="10-parameterized"><a href="#10-parameterized" class="headerlink" title="10 parameterized"></a>10 parameterized</h4><p><a href="https://github.com/wolever/parameterized">https://github.com/wolever/parameterized</a></p>
<p>为测试用例提供参数化的，重复性支持</p>
<h4 id="11-pytest"><a href="#11-pytest" class="headerlink" title="11 pytest"></a>11 pytest</h4><p><a href="https://docs.pytest.org/en/latest/">https://docs.pytest.org/en/latest/</a></p>
<p>强大的第三方测试框架，丰富的插件集，活跃的社区</p>
<p>当然还有 <code>nose</code> 和 它的继任者 <code>nose2</code>，不过相比较而言，还是更加青睐于 <code>pytest</code></p>
<p><code>nose</code>：<a href="https://nose.readthedocs.io/en/latest/">https://nose.readthedocs.io/en/latest/</a><br><code>nose2</code>：<a href="https://github.com/nose-devs/nose2">https://github.com/nose-devs/nose2</a></p>
<p>不过 <code>nose</code> 已经不再更新，进入了维护阶段，如果使用建议使用 <code>nose2</code></p>
<h4 id="12-raven"><a href="#12-raven" class="headerlink" title="12 raven"></a>12 raven</h4><p><a href="https://raven.readthedocs.io/en/feature-federated-docs/">https://raven.readthedocs.io/en/feature-federated-docs/</a></p>
<p>这个一般都是结合 <code>Sentry</code> 使用</p>
<h4 id="13-mysqlclient"><a href="#13-mysqlclient" class="headerlink" title="13 mysqlclient"></a>13 mysqlclient</h4><p><a href="https://github.com/PyMySQL/mysqlclient-python">https://github.com/PyMySQL/mysqlclient-python</a></p>
<p>因为我使用 <code>Mysql</code> 较多</p>
<h4 id="14-django-silk"><a href="#14-django-silk" class="headerlink" title="14 django-silk"></a>14 django-silk</h4><p><a href="https://github.com/jazzband/django-silk">https://github.com/jazzband/django-silk</a></p>
<p>简单的性能监控工具</p>
<h4 id="15-django-debug-toolbar"><a href="#15-django-debug-toolbar" class="headerlink" title="15 django-debug-toolbar"></a>15 django-debug-toolbar</h4><p><a href="https://github.com/jazzband/django-debug-toolbar">https://github.com/jazzband/django-debug-toolbar</a></p>
<p><code>debug</code> 工具</p>
<h4 id="16-django-reversion"><a href="#16-django-reversion" class="headerlink" title="16 django-reversion"></a>16 django-reversion</h4><p><a href="https://github.com/etianen/django-reversion">https://github.com/etianen/django-reversion</a></p>
<p>模型版本控制</p>
<h4 id="17-whitenoise"><a href="#17-whitenoise" class="headerlink" title="17 whitenoise"></a>17 whitenoise</h4><p><a href="https://github.com/evansd/whitenoise">https://github.com/evansd/whitenoise</a></p>
<p>静态资源管理，通常是用来管理 <code>django admin</code> 和其他第三方包的静态资源。</p>
<h4 id="18-django-sql-explorer"><a href="#18-django-sql-explorer" class="headerlink" title="18 django-sql-explorer"></a>18 django-sql-explorer</h4><p><a href="https://github.com/groveco/django-sql-explorer">https://github.com/groveco/django-sql-explorer</a></p>
<p><code>SQL</code> 运行查询辅助工具</p>
<h4 id="19-django-import-export"><a href="#19-django-import-export" class="headerlink" title="19 django-import-export"></a>19 django-import-export</h4><p><a href="https://github.com/django-import-export/django-import-export">https://github.com/django-import-export/django-import-export</a></p>
<p>数据导入导出</p>
<h4 id="20-django-compressor"><a href="#20-django-compressor" class="headerlink" title="20 django-compressor"></a>20 django-compressor</h4><p><a href="https://django-compressor.readthedocs.io/en/stable/">https://django-compressor.readthedocs.io/en/stable/</a></p>
<p>合并静态资源，减少网络请求，一般使用在 <code>django admin</code> 中。</p>
]]></content>
      <categories>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>Django | 虚拟字段</title>
    <url>/posts/37001/</url>
    <content><![CDATA[<p>这次写写 Django 模型中的虚拟字段。这个虚拟字段很有意思，在某些场景下，反查可以让业务代码看起来很清晰，大部分时候都是结合 <code>prefetch_related</code> 和 <code>select_related</code> 来使用。<span id="more"></span></p>
<h3 id="1-模型"><a href="#1-模型" class="headerlink" title="1 模型"></a>1 模型</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Category</span>(models.Model):</span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        to=settings.AUTH_USER_MODEL,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">&#x27;category_user&#x27;</span>,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        default=<span class="literal">None</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span>(models.Model):</span><br><span class="line">    user = models.OneToOneField(to=settings.AUTH_USER_MODEL, on_delete=models.CASCADE)</span><br><span class="line">    category = models.ManyToManyField(Category)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(models.Model):</span><br><span class="line">    article = models.OneToOneField(</span><br><span class="line">        Article, on_delete=models.CASCADE, related_name=<span class="string">&#x27;books&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tag</span>(models.Model):</span><br><span class="line">    article = models.ForeignKey(Article, on_delete=models.CASCADE)</span><br><span class="line">    users = models.ManyToManyField(User, related_name=<span class="string">&#x27;tag_users&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里写了分类模型和文章模型，里面包含了基本的三种关系：</p>
<ul>
<li>OneToOneField</li>
<li>ForeignKey</li>
<li>ManyToManyField</li>
</ul>
<h3 id="2-模型中的虚拟字段"><a href="#2-模型中的虚拟字段" class="headerlink" title="2 模型中的虚拟字段"></a>2 模型中的虚拟字段</h3><p>虚拟字段一般存在于父模型中。对于上述三种关系，虚拟字段的名称都会受是否指定 <code>related_name</code> 的影响。</p>
<p><strong>规则 1：</strong></p>
<blockquote>
<p>如果引用模型指定了 related_name，那么父模型（被引用模型）存在指定的 related_name 名称的字段</p>
</blockquote>
<p><strong>规则 2：</strong></p>
<blockquote>
<p>如果没有指定 related_name，那么父模型（被引用模型）存在子模型小写名称的字段</p>
</blockquote>
<h4 id="2-1-OneToOneField-关系下的验证"><a href="#2-1-OneToOneField-关系下的验证" class="headerlink" title="2.1 OneToOneField 关系下的验证"></a>2.1 OneToOneField 关系下的验证</h4><h5 id="2-1-1-指定了-related-name"><a href="#2-1-1-指定了-related-name" class="headerlink" title="2.1.1 指定了 related_name"></a>2.1.1 指定了 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">5</span>]: Article._meta.get_field(<span class="string">&#x27;books&#x27;</span>)</span><br><span class="line">Out[<span class="number">5</span>]: &lt;OneToOneRel: mallshop.book&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: Article._meta.get_field(<span class="string">&#x27;books&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">7</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Book</code> 模型引用了 <code>Article</code> 模型，同时指定了 <code>related_name</code>, 这时 <code>Article</code> 模型存在 <code>books</code> 的虚拟字段</p>
<h5 id="2-1-2-没有指定-related-name"><a href="#2-1-2-没有指定-related-name" class="headerlink" title="2.1.2 没有指定 related_name"></a>2.1.2 没有指定 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: User._meta.get_field(<span class="string">&#x27;article&#x27;</span>)</span><br><span class="line">Out[<span class="number">8</span>]: &lt;OneToOneRel: mallshop.article&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: User._meta.get_field(<span class="string">&#x27;article&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">9</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Article</code> 模型引用了 <code>User</code> 模型，没有指定 <code>related_name</code>，这时 <code>User</code> 模型存在 <code>artilce</code> 虚拟字段</p>
<h4 id="2-2-ForeignKey-关系下的验证"><a href="#2-2-ForeignKey-关系下的验证" class="headerlink" title="2.2 ForeignKey 关系下的验证"></a>2.2 ForeignKey 关系下的验证</h4><h5 id="2-2-1-指定了-related-name"><a href="#2-2-1-指定了-related-name" class="headerlink" title="2.2.1 指定了 related_name"></a>2.2.1 指定了 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: User._meta.get_field(<span class="string">&#x27;category_user&#x27;</span>)</span><br><span class="line">Out[<span class="number">10</span>]: &lt;ManyToOneRel: mallshop.category&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: User._meta.get_field(<span class="string">&#x27;category_user&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">11</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Category</code> 模型引用了 <code>User</code> 模型，同时指定了 <code>related_name</code>, 这时 <code>User</code> 模型存在 <code>category_user</code> 的虚拟字段</p>
<h5 id="2-2-2-没有指定-related-name"><a href="#2-2-2-没有指定-related-name" class="headerlink" title="2.2.2 没有指定 related_name"></a>2.2.2 没有指定 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: Article._meta.get_field(<span class="string">&#x27;tag&#x27;</span>)</span><br><span class="line">Out[<span class="number">12</span>]: &lt;ManyToOneRel: mallshop.tag&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">13</span>]: Article._meta.get_field(<span class="string">&#x27;tag&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">13</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Tag</code> 模型引用了 <code>Article 模型</code>，没有指定 <code>related_name</code>，这时 <code>Article</code> 模型存在 <code>tag</code> 虚拟字段</p>
<h4 id="2-3-ManyToManyField-关系下的验证"><a href="#2-3-ManyToManyField-关系下的验证" class="headerlink" title="2.3 ManyToManyField 关系下的验证"></a>2.3 ManyToManyField 关系下的验证</h4><h5 id="2-3-1-指定了-related-name"><a href="#2-3-1-指定了-related-name" class="headerlink" title="2.3.1 指定了 related_name"></a>2.3.1 指定了 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: User._meta.get_field(<span class="string">&#x27;tag_users&#x27;</span>)</span><br><span class="line">Out[<span class="number">1</span>]: &lt;ManyToManyRel: mallshop.tag&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: User._meta.get_field(<span class="string">&#x27;tag_users&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Tag</code> 模型引用了 <code>User</code> 模型，同时指定了 <code>related_name</code> 为 <code>tag_users</code>, 这时 <code>User</code> 模型存在 <code>tag_users</code> 的虚拟字段</p>
<h5 id="2-3-2-没有指定-related-name"><a href="#2-3-2-没有指定-related-name" class="headerlink" title="2.3.2 没有指定 related_name"></a>2.3.2 没有指定 related_name</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: Category._meta.get_field(<span class="string">&#x27;article&#x27;</span>)</span><br><span class="line">Out[<span class="number">15</span>]: &lt;ManyToManyRel: mallshop.article&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">16</span>]: Category._meta.get_field(<span class="string">&#x27;article&#x27;</span>).concrete</span><br><span class="line">Out[<span class="number">16</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><code>Article</code> 模型引用了 <code>Category</code> 模型，没有指定 <code>related_name</code>，这时 <code>Category</code> 模型存在 <code>article</code> 虚拟字段</p>
<h3 id="3-模型实例访问虚拟字段"><a href="#3-模型实例访问虚拟字段" class="headerlink" title="3 模型实例访问虚拟字段"></a>3 模型实例访问虚拟字段</h3><p>如果在模型实例，访问虚拟字段时，这里需要注意以下规则：</p>
<p><strong>规则 1：</strong></p>
<blockquote>
<p>如果是 OneToOneField 关系，访问模型实例的虚拟字段属性时，这时返回的是子模型的实例</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: user = User.objects.first()</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: user.article</span><br><span class="line">Out[<span class="number">4</span>]: &lt;Article: Article <span class="built_in">object</span> (<span class="number">1</span>)&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: user.article.books</span><br><span class="line">Out[<span class="number">5</span>]: &lt;Book: Book <span class="built_in">object</span> (<span class="number">1</span>)&gt;</span><br></pre></td></tr></table></figure>

<p><strong>规则 2：</strong></p>
<blockquote>
<p>如果是非 OneToOneField 关系，同时指定了 related_name，访问模型实例的虚拟字段属性时，这时返回的是 RelatedManager 实例</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">9</span>]: user.category_user</span><br><span class="line">Out[<span class="number">9</span>]: &lt;django.db.models.fields.related_descriptors.create_reverse_many_to_one_manager.&lt;<span class="built_in">locals</span>&gt;.RelatedManager at <span class="number">0x107c10610</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>规则 3：</strong></p>
<blockquote>
<p>如果是非 OneToOneField 关系，同时没有指定 related_name，访问模型实例的虚拟字段属性时，这个时候会抛出异常，如果想得到一个 RelatedManager 实例，则需要在虚拟字段后加上 _set 后，在进行访问</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">6</span>]: article = Article.objects.first()</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: article.tag</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">AttributeError                            Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span>-<span class="number">7</span>-ad987724bf64&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> article.tag</span><br><span class="line"></span><br><span class="line">AttributeError: <span class="string">&#x27;Article&#x27;</span> <span class="built_in">object</span> has no attribute <span class="string">&#x27;tag&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: article.tag_set</span><br><span class="line">Out[<span class="number">8</span>]: &lt;django.db.models.fields.related_descriptors.create_reverse_many_to_one_manager.&lt;<span class="built_in">locals</span>&gt;.RelatedManager at <span class="number">0x108053220</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-小结"><a href="#4-小结" class="headerlink" title="4 小结"></a>4 小结</h3><p>虚拟字段，注意在模型和模型实例下的使用方式。</p>
<p>话说虚拟字段有啥用，可以反查，在我使用的场景中，最大的好处是可以基于 <code>DRF</code> 动态构建序列化类，例如想得到一篇文章，这个文章还要包含些作者信息，前端可以这样传</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;display_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;username&quot;</span><span class="punctuation">,</span> <span class="string">&quot;id&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;id&quot;</span><span class="punctuation">,</span> <span class="string">&quot;name&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回的结果</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ceshi1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;吴小楠&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tag1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>后端可以根据前端传递的获取字段列表进行校验，验证通过后根据获取的字段动态的生成对应的序列化类，嵌套的序列化类也只包含指定的字段，这样在服务端可以提升些接口性能。返回给前端，这个我是参考了 <code>graphql</code> 的模式，前端需要返回什么，就指定什么。</p>
<p>如果使用 Django，虚拟字段的使用时避免不了的，深度挖掘虚拟字段的使用，会跟业务带来很大的便利性。</p>
]]></content>
      <categories>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF：书写接口的通用流程</title>
    <url>/posts/11214/</url>
    <content><![CDATA[<p>描述：书写接口的基本流程</p>
<span id="more"></span>

<p>在使用 <code>django-restful-framework</code> 写后台接口的业务中，在下通用的做法；</p>
<blockquote>
<p>前端数据数据—-&gt;检测(包含限流，认证，权限验证，数据检测)—-&gt;持久化</p>
</blockquote>
<p>其中对于限流和权限验证，都可以自定义类解决需求，重点还是在于数据检测，本着不能相信前端输入的数据的原则，要做好数据检测，也不是件轻而易举的事情，毕竟疯子的想法你是猜不透的。</p>
<p>这里针对数据检测，在这里说说我的通用做法，还是以例说明：</p>
<h3 id="1-场景：认证服务"><a href="#1-场景：认证服务" class="headerlink" title="1 场景：认证服务"></a>1 场景：认证服务</h3><p>这里只是简单的验证用户，根据用户输入的姓名，身份证号码，手机号码（需要填写手机号码是为了短信验证，这年头，不加点料，都对不起自己），验证输入的信息是否合法，当然这个验证不是很靠谱，只是为了做个例子而已，不用太当真，不然掉进了你是谁，我又是谁的黑洞，那就完蛋了。</p>
<h3 id="2-业务流程步骤"><a href="#2-业务流程步骤" class="headerlink" title="2 业务流程步骤"></a>2 业务流程步骤</h3><p>说明：代码以伪代码为主</p>
<h4 id="2-1-准备两个-serializer"><a href="#2-1-准备两个-serializer" class="headerlink" title="2.1 准备两个 serializer"></a>2.1 准备两个 serializer</h4><p>为什么要准备两个 <code>serializer</code>，因为：</p>
<ul>
<li>输入的数据结构和你期望返回的数据结构有可能是不一样的</li>
<li>业务拆分，保持业务独立，清晰</li>
</ul>
<p>检测数据的 serializer:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VerifyForm</span>(serializers.Serializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证认证用户输入数据&quot;&quot;&quot;</span></span><br><span class="line">    username = serializers.CharField(max_length=<span class="number">64</span>, min_length=<span class="number">2</span>)</span><br><span class="line">    id_number = serializers.CharField(max_length=<span class="number">18</span>, min_length=<span class="number">15</span>)</span><br><span class="line">    sms_code = serializers.CharField(max_length=<span class="number">6</span>, min_length=<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_username</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">if</span> 检测输入的用户名不合法:</span><br><span class="line">            <span class="keyword">raise</span> 异常</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_id_number</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">if</span> 检测输入的身份证号码不合法:</span><br><span class="line">            <span class="keyword">raise</span> 异常</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_sms_code</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="keyword">if</span> 检测输入的短信验证码不合法:</span><br><span class="line">            <span class="keyword">raise</span> 异常</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, attrs</span>):</span><br><span class="line">        <span class="keyword">if</span> 外部服务(username, id_number) 不合法:</span><br><span class="line">            <span class="keyword">raise</span> 异常</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">         持久化</span><br><span class="line">         <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>

<p>序列化对象的 serializer:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VerifySerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;序列化数据&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    你可以做点自己喜欢的事情，啊哈</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Verify</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-书写-views"><a href="#2-2-书写-views" class="headerlink" title="2.2 书写 views"></a>2.2 书写 views</h4><p>针对创建的业务，示例如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">    <span class="keyword">return</span> serializer.save()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">    serializer = VerifyForm(data=request.data, context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">    <span class="comment"># 检验数据</span></span><br><span class="line">    serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 持久化</span></span><br><span class="line">    instance = self.perform_create(serializer)</span><br><span class="line">    <span class="comment"># 序列化数据</span></span><br><span class="line">    serializer = self.get_serializer(instance)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>

<h3 id="3-小结"><a href="#3-小结" class="headerlink" title="3 小结"></a>3 小结</h3><p>这种做法是我通常写接口业务的流程，验证检测归验证检测，序列化归序列化，两种类型互不干扰，当然对于简单的业务你可以全部放到同一个 serializer 中，这个根据自己的业务需求走，没有更好，只有合适。</p>
]]></content>
      <categories>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Django-Rest-Framework</tag>
      </tags>
  </entry>
  <entry>
    <title>资源加速系列之 pip</title>
    <url>/posts/26327/</url>
    <content><![CDATA[<p>在 <code>python</code> 项目中，安装包时，都会从官方默认的源：<span id="more"></span></p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">https:</span>//pypi<span class="meta">.org</span>/simple</span><br></pre></td></tr></table></figure>

<p>中下载，速度较慢，原因不多说了，针对这个情况，国内有些公司和机构做了镜像站，以便国内的用户提高下载速度。</p>
<!--more-->

<h3 id="1-国内的镜像源列表"><a href="#1-国内的镜像源列表" class="headerlink" title="1 国内的镜像源列表"></a>1 国内的镜像源列表</h3><p>列举几个常用的，少用的就不列了</p>
<ul>
<li><a href="https://mirrors.aliyun.com/pypi/simple/">https://mirrors.aliyun.com/pypi/simple/</a> 阿里云</li>
<li><a href="https://pypi.tuna.tsinghua.edu.cn/simple/">https://pypi.tuna.tsinghua.edu.cn/simple/</a> 清华大学</li>
<li><a href="https://pypi.doubanio.com/simple/">https://pypi.doubanio.com/simple/</a> 豆瓣</li>
<li><a href="https://mirrors.ustc.edu.cn/pypi/web/simple/">https://mirrors.ustc.edu.cn/pypi/web/simple/</a> 中国科学技术大学</li>
</ul>
<p>上面的源站都测试过，对我来说，首选阿里云，因为确实快</p>
<h3 id="2-临时指定镜像源"><a href="#2-临时指定镜像源" class="headerlink" title="2 临时指定镜像源"></a>2 临时指定镜像源</h3><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> -i 镜像源地址 包名称</span><br></pre></td></tr></table></figure>

<p>例如安装 <code>django</code>，选用阿里云镜像源，则</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">pip install -i https:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/pypi/</span>simple/ django</span><br></pre></td></tr></table></figure>

<h3 id="3-全局设置镜像源"><a href="#3-全局设置镜像源" class="headerlink" title="3 全局设置镜像源"></a>3 全局设置镜像源</h3><p>我个人使用的是 mac，步骤：</p>
<p>1 在用户主目录下 <code>~/.config</code> 中新建 <code>pip</code> 文件夹（也可以直接在用户主目录下建立 <code>.pip</code> 文件夹)</p>
<p>2 在上一步新建的文件中新建 <code>pip.conf</code></p>
<p>3 在 <code>pip.conf</code> 文件中添加以下配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">global</span>]</span><br><span class="line">timeout = <span class="number">60</span></span><br><span class="line">index-url = https://mirrors.aliyun.com/pypi/simple</span><br><span class="line"></span><br><span class="line">[install]</span><br><span class="line">trusted-host=mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<p>可以阅览官方文档：<a href="https://pip.pypa.io/en/stable/user_guide/#config-file">https://pip.pypa.io/en/stable/user_guide/#config-file</a></p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">You can <span class="built_in">set</span> <span class="keyword">a</span> custom path location <span class="keyword">for</span> this config</span><br><span class="line"><span class="built_in">file</span> <span class="keyword">using</span> <span class="keyword">the</span> environment <span class="built_in">variable</span> PIP_CONFIG_FILE.</span><br></pre></td></tr></table></figure>

<p>用户可以自定义配置文件路径，配置好环境变量 <code>PIP_CONFIG_FILE</code> 即可。</p>
<p>后续再安装 <code>python</code> 包都会使用设置好的源，节省时间。</p>
]]></content>
      <categories>
        <category>资源加速</category>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>加速</tag>
        <tag>镜像</tag>
      </tags>
  </entry>
  <entry>
    <title>资源加速系列之 pyenv</title>
    <url>/posts/22631/</url>
    <content><![CDATA[<p>对于 <code>python</code> 相关的业务，我都是使用 <code>pyenv</code>，来管理我本地的 <code>python</code> 版本，由于不同项目的需要，有些项目使用的 <code>python</code> 版本都是不一致，所以本地安装了不同的版本。<span id="more"></span></p>
<h3 id="1-加速"><a href="#1-加速" class="headerlink" title="1 加速"></a>1 加速</h3><p>刚开始装 <code>python</code>，都是执行 <code>pyenv install 版本号</code> 进行安装，但是发现速度，在国内，你懂得，太慢，所以就去找镜像，我使用了淘宝的镜像，地址如下</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>npm.taobao.org<span class="regexp">/mirrors/</span>python/</span><br></pre></td></tr></table></figure>

<p>其实加速就是从镜像地址把指定版本的 <code>python</code> 压缩包下载到 <code>~/.pyenv/cache</code> 下面，然后执行 <code>pyenv install 对应的版本号</code> 即可。</p>
<p>例如安装 3.6.7 版本，命令行如下</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">v=<span class="number">3.6</span>.<span class="number">7</span>;wget https:<span class="regexp">//</span>npm.taobao.org<span class="regexp">/mirrors/</span>python<span class="regexp">/$v/</span>Python-<span class="variable">$v</span>.tar.xz -P ~<span class="regexp">/.pyenv/</span>cache/;pyenv install <span class="variable">$v</span></span><br></pre></td></tr></table></figure>

<h3 id="2-做成可执行文件"><a href="#2-做成可执行文件" class="headerlink" title="2 做成可执行文件"></a>2 做成可执行文件</h3><p>我个人是有懒癌的，如果每次安装其他版本，都要这么执行，输入一长串，受不鸟，那就封装成 <code>shell</code> 脚本，脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">pyenvInstallPython</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$1</span></span><br><span class="line">    v=<span class="variable">$1</span></span><br><span class="line">    wget https://npm.taobao.org/mirrors/python/<span class="variable">$v</span>/Python-<span class="variable">$v</span>.tar.xz -P ~/.pyenv/cache/;pyenv install <span class="variable">$v</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pyenvInstallPython $*</span><br></pre></td></tr></table></figure>

<p>然后把这个脚本写到可执行文件（我起的名字叫做 <code>pyversion</code>)中，然后把可执行文件移动到可执行目录中（即能在 <code>$PATH</code> 指定的路径中找到这个文件），我个人的做法，在我的用户目录建立了一个 <code>bin</code> 目录（加入到 <code>$PATH</code> 中去），然后把 <code>pyversion</code> 这个可执行文件移动到 <code>~/bin</code> 中去。</p>
<p>好了，可以了，后面想安装对应的版本，直接在终端中执行</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">pyversion</span> 版本号</span><br></pre></td></tr></table></figure>

<h3 id="3-测试"><a href="#3-测试" class="headerlink" title="3 测试"></a>3 测试</h3><p>例如我要装 3.6.7 版本，在终端执行 <code>pyversion 3.6.7</code>，执行结果：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3.6.7</span><br><span class="line">--2016-10-22 01:16:10--  https://npm.taobao.org/mirrors/python/3.6.7/Python-3.6.7.tar.xz</span><br><span class="line">正在解析主机 npm.taobao.org (npm.taobao.org)... 114.55.80.225</span><br><span class="line">正在连接 npm.taobao.org (npm.taobao.org)|114.55.80.225|:443... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 302 Found</span><br><span class="line">位置：https://cdn.npm.taobao.org/dist/python/3.6.7/Python-3.6.7.tar.xz [跟随至新的 URL]</span><br><span class="line">--2016-10-22 01:16:10--  https://cdn.npm.taobao.org/dist/python/3.6.7/Python-3.6.7.tar.xz</span><br><span class="line">正在解析主机 cdn.npm.taobao.org (cdn.npm.taobao.org)... 119.147.111.226, 119.147.111.229, 113.105.168.156, ...</span><br><span class="line">正在连接 cdn.npm.taobao.org (cdn.npm.taobao.org)|119.147.111.226|:443... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：17178476 (16M) [application/x-xz]</span><br><span class="line">正在保存至: “/Users/kycool/.pyenv/cache/Python-3.6.7.tar.xz”</span><br><span class="line"></span><br><span class="line">Python-3.6.7.tar.xz              100%[========================================================&gt;]  16.38M  8.36MB/s  用时 2.0s</span><br><span class="line"></span><br><span class="line">2016-10-22 01:16:12 (8.36 MB/s) - 已保存 “/Users/kycool/.pyenv/cache/Python-3.6.7.tar.xz” [17178476/17178476])</span><br><span class="line"></span><br><span class="line">python-build: use openssl@1.1 from homebrew</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Installing Python-3.6.7...</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">python-build: use zlib from xcode sdk</span><br><span class="line">Installed Python-3.6.7 to /Users/kycool/.pyenv/versions/3.6.7</span><br></pre></td></tr></table></figure>

<p>速度果然是杠杠的，再输入 <code>pyenv versions</code> 看下</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ pyenv versions</span><br><span class="line">* system (set by <span class="regexp">/Users/</span>kycool<span class="regexp">/.pyenv/</span>version)</span><br><span class="line">  <span class="number">3.6</span>.<span class="number">0</span></span><br><span class="line">  <span class="number">3.6</span>.<span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>可以，后续就可以这样玩了，省时省力。</p>
]]></content>
      <categories>
        <category>资源加速</category>
        <category>后端</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>加速</tag>
        <tag>镜像</tag>
      </tags>
  </entry>
</search>
